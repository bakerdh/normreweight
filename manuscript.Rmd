---
title: "Normalization Reweighting"
author: "Daniel H. Baker"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

runcode <- 1  # this flag chooses whether to run the underlying analysis code (1), or just load in the figures from the last time this was run (0)
processraw <- 0  # this flag determines whether the raw data are downloaded from OSF and processed - this will require ~30GB of hard drive space and take several hours


# reasonably compact code to check which packages are installed, install the missing ones, and activate all
packagelist <- c('knitr','remotes','tictoc') # list of CRAN packages
missingpackages <- packagelist[!packagelist %in% installed.packages()[,1]]
if (length(missingpackages)>0){install.packages(missingpackages)}
if (!'osfr' %in% installed.packages()[,1]){remotes::install_github("centerforopenscience/osfr")}
if (!'FourierStats' %in% installed.packages()[,1]){remotes::install_github("bakerdh/FourierStats")}
packagelist <- c(packagelist,'osfr','FourierStats')
toinstall <- packagelist[which(!packagelist %in% (.packages()))]
invisible(lapply(toinstall,library,character.only=TRUE))


# helper function to make colours transparent
addalpha <- function(col, alpha=1){apply(sapply(col, col2rgb)/255, 2, function(x) rgb(x[1], x[2], x[3], alpha=alpha))}

knitr::opts_chunk$set(echo = TRUE)

# check if a directory exists to store data files (ignored by git)
if (!dir.exists('temp/')){dir.create('temp/')}
if (!dir.exists('temp/VilidaiteProcessed/')){dir.create('temp/VilidaiteProcessed/')}

targetelectrodes <- c('Oz','POz','O1','O2')

```

## Abstract


## Introduction



## Results

Figure summarising the Vilidaite reanalysis
Contrast response functions?
Waveforms
Spectra with scalp distributions
Timecourse for each condition & frequency
NR for each frequency
AQ distribution
Median AQ split

```{r}

samplerate <- 1000
targetF <- 7
maskF <- 5
tindex <- (10*targetF) + 1
mindex <- (10*maskF) + 1
duration <- 14

if (processraw==1){
  
# datadir <- '/Volumes/Seagate/EEG data/UG2014/tar/'
# tempdir <- '/Volumes/Seagate/EEG data/UG2014/tar/temp/'
datadir <- 'temp/raw/'
tempdir <- 'temp/raw/temp/'

hdata <- read.csv('~/Google Drive/Current work/R scripts/EEG analysis/headerfile.csv', header = TRUE)
legaltriggers <- hdata$Trigger[!is.na(hdata$Trigger)]
subcounter <- 0

for (s in 1:101) {
  if (s != 75) {
    subcounter <- subcounter + 1  
  if (!file.exists(paste0('temp/VilidaiteProcessed/V',subcounter,'processed.RData'))){
  print(s)

    condcounter <- (1:20) * 0
    allsamples <- array(0, dim = c(10,20,64,duration*samplerate))
    if (s < 10){untar(paste(datadir, 'S0', s, '.tar', sep = ''), exdir = tempdir)}
    if (s > 9){untar(paste(datadir, 'S', s, '.tar', sep = ''), exdir = tempdir)}
    
    d <- dir(path = tempdir, pattern = '*.csv.gz')
    
    for (block in 1:length(d)) {
      EEGdata <- read.csv(paste(tempdir, d[block], sep = ''), header = TRUE)
      
      electrodes <- colnames(EEGdata)
      targetchannels <- match(targetelectrodes, electrodes) - 2
      
      # epoch the data, Fourier transform and store
      triggertimes <- (1:40) * 0
      counter <- 0
      for (n in 1:nrow(EEGdata)) {
        if (EEGdata$Trigger[n] %in% legaltriggers) {
          counter <- counter + 1
          triggertimes[counter] <- n
        }
      }
      
      for (tr in 1:counter) {
        cond <- EEGdata$Trigger[triggertimes[tr]] / 10
        condcounter[cond] <- condcounter[cond] + 1
        for (ch in 1:64){
        temp <- as.matrix(EEGdata[(triggertimes[tr]:(triggertimes[tr] + samplerate * duration - 1))-999, ch + 2])
        temp <- temp - mean(temp[1:1000])   # baseline subtraction to remove DC component
        allsamples[condcounter[cond],cond,ch,1:(1000*duration)] <- as.vector(rowMeans(temp))
        }
      }
    }
allsamples[which(is.na(allsamples))] <- 0     # remove any NaN values
meanwaveforms <- array(0,dim=c(14,64,14000))
    for (cond in 1:14){
      for (ch in 1:64){
        temp <- allsamples[1:condcounter[cond],cond,ch,]
        allspec <- matrix(0,nrow=condcounter[cond],ncol=10000)
        for (trial in 1:condcounter[cond]){
          allspec[trial,] <- fft(temp[trial,2001:12000])/10000
        }
        targetresps <- allspec[,tindex]
        maskresps <- allspec[,mindex]
      if (sum(abs(targetresps))>0){  
      tempxy <- data.frame(Re(targetresps),Im(targetresps))
      D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      i1 <- (D<3)
      tempxy <- data.frame(Re(maskresps),Im(maskresps))
      D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      i2 <- (D<3)
      i <- which((i1*i2)>0)
        meanwaveforms[cond,ch,] <- colMeans(temp[i,])
      }
      }
    }
    
     save(file = paste0('temp/VilidaiteProcessed/V',subcounter,'processed.RData'), list = c('meanwaveforms','electrodes'))
     
    for (block in 1:length(d)){file.remove(paste0(tempdir, d[block]))}

  }
}
}
}


if (runcode==1){
  d <- dir('temp/VilidaiteProcessed/')
  
  allwaves <- array(0,dim=c(length(d),14,64,14000))
  for (s in 1:length(d)){
    load(paste0('temp/VilidaiteProcessed/',d[s]))
    allwaves[s,,,] <- meanwaveforms
  }
  
  meanwaveforms <- array(0,dim=c(14,64,14000))
  alltarget <- matrix(0,nrow=14,ncol=64)
  allmask <- matrix(0,nrow=14,ncol=64)
    for (cond in 1:14){
      for (ch in 1:64){
        temp <- allwaves[,cond,ch,]
        allspec <- matrix(0,nrow=length(d),ncol=10000)
        for (subj in 1:length(d)){
          allspec[subj,] <- fft(temp[subj,2001:12000])/10000
        }
        targetresps <- allspec[,tindex]
        maskresps <- allspec[,mindex]
      if (sum(abs(targetresps))>0){  
      tempxy <- data.frame(Re(targetresps),Im(targetresps))
      D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      i1 <- (D<3)
      tempxy <- data.frame(Re(maskresps),Im(maskresps))
      D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      i2 <- (D<3)
      i <- which((i1*i2)>0)
        meanwaveforms[cond,ch,] <- colMeans(temp[i,])
      }
        spec <- fft(meanwaveforms[cond,ch,2001:12000])/10000
        alltarget[cond,ch] <- spec[tindex]
        allmask[cond,ch] <- spec[mindex]
      }
    }
  
}

targetchannels <- match(targetelectrodes, electrodes) - 2

elecave <- colMeans(meanwaveforms[6,targetchannels,])
binwidth <- 1000
f1 <- 7
tindex <- 1 + f1*(binwidth/1000)
fspec <- elecave*0
for (t in 1:(length(elecave)-binwidth)){
  temp <- elecave[t:(t+binwidth-1)]
  spec <- fft(temp)/binwidth
  fspec[t] <- abs(spec[tindex])
}
elecave <- colMeans(meanwaveforms[13,targetchannels,])
binwidth <- 1000
f1 <- 7
tindex <- 1 + f1*(binwidth/1000)
fspec2 <- elecave*0
for (t in 1:(length(elecave)-binwidth)){
  temp <- elecave[t:(t+binwidth-1)]
  spec <- fft(temp)/binwidth
  fspec2[t] <- abs(spec[tindex])
}

times <- -499:13500
plot(times,fspec,type='l',col='red')
lines(times,fspec2,col='green')




# all electrodes, condition 6 @ 7Hz
# all electrodes, condition 8 @ 5Hz
# target electrodes, conditions 1-14 for CRF, 5&7Hz
# target electrodes, full timecourse at 5 & 7Hz, conditions 6, 8, 13
# allwaves dimensions: 67 x 14 x 64 x 14000

temp <- allwaves[,6,,2001:12000]
meantemp <- apply(allwaves,2:3,mean)

f1 <- 7
f2 <- 5
    binwidth <- 1000
    tindex <- 1 + f1*(binwidth/1000)
    mindex <- 1 + f2*(binwidth/1000)
condlist <- c(6,8,13)
targetchannels <- match(targetelectrodes, electrodes) - 2
d <- dir('temp/VilidaiteProcessed/')
all7Hz <- array(0,dim=c(length(d),14,64))
all5Hz <- array(0,dim=c(length(d),14,64))
timecourse7Hz <- array(0,dim=c(length(d),3,14000))
timecourse5Hz <- array(0,dim=c(length(d),3,14000))

  for (s in 1:length(d)){
    tic()
    load(paste0('temp/VilidaiteProcessed/',d[s]))
    
    for (cond in 1:14){
      for (ch in 1:64){
        temp <- meanwaveforms[cond,ch,2001:12000]
        spec <- fft(temp)/length(temp)
        all7Hz[s,cond,ch] <- spec[7*10+1]
        all5Hz[s,cond,ch] <- spec[5*10+1]
      }
    }
    for (cond in 1:3){
    temp <- colMeans(meanwaveforms[condlist[cond],targetchannels,])

fspec1 <- temp*0
fspec2 <- temp*0
for (t in 1:(length(temp)-binwidth)){
  spec <- fft(temp[t:(t+binwidth-1)])/binwidth
  fspec1[t] <- abs(spec[tindex])
  fspec2[t] <- abs(spec[mindex])
}
    timecourse7Hz[s,cond,] <- fspec1
    timecourse5Hz[s,cond,] <- fspec2
    
    }
    
    print(toc())
    
  }

mean7 <- apply(all7Hz[,,targetchannels],1:2,mean)
mean5 <- apply(all5Hz[,,targetchannels],1:2,mean)
inclusionmatrix7 <- matrix(0,nrow=length(d),ncol=length(condlist))
inclusionmatrix5 <- matrix(0,nrow=length(d),ncol=length(condlist))
for (cond in 1:3){
  temp <- mean7[,condlist[cond]]
        tempxy <- data.frame(Re(temp),Im(temp))
      D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      inclusionmatrix7[,cond] <- (D<3)
   temp <- mean5[,condlist[cond]]
        tempxy <- data.frame(Re(temp),Im(temp))
      D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      inclusionmatrix5[,cond] <- (D<3)
}

meantime5Hz <- matrix(0,nrow=length(condlist),ncol=14000) 
meantime7Hz <- matrix(0,nrow=length(condlist),ncol=14000) 
for (cond in 1:3){
meantime7Hz[cond,] <- abs(apply(timecourse7Hz[which(inclusionmatrix7[,cond]>0),cond,],2,mean))
meantime5Hz[cond,] <- abs(apply(timecourse5Hz[which(inclusionmatrix5[,cond]>0),cond,],2,mean))
}

plot(-499:13500,meantime5Hz[2,],type='l',col='red')
lines(-499:13500,meantime5Hz[1,],col='black')
lines(-499:13500,meantime5Hz[3,],col='green')

plot(-499:13500,meantime7Hz[1,],type='l',col='red')
lines(-499:13500,meantime7Hz[2,],col='black')
lines(-499:13500,meantime7Hz[3,],col='green')


```



Figure summarising the EEG experiment
Stimuli?
Waveforms
Spectra with scalp distributions
Timecourse for each condition & frequency
NR for each frequency, mon & dich
AQ vs SPQ with distributions on margins
Median AQ split


Figure summarising the MEG experiment
Brains showing location of activity and V1 ROI
Spectra, timecourses
NR for each frequency, mon & dich, split by group


## Discussion



## Methods




```{r cars}
summary(cars)
```
