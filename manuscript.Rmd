---
title: 'Temporal Dynamics of Normalization Reweighting (target journal: Neuron)'
author: Daniel H. Baker, Daniela Marinova, Richard Aveyard, Lydia Hargreaves, Alice
  Renton, Ruby Castellani, Phoebe Hall, Miriam Harmens, Georgia Holroyd, Beth Nicholson,
  Emily Williams, Hannah M. Hobson & Alex R. Wade
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    toc: no
    keep_tex: yes
  word_document: default
  pdf_document:
    toc: no
  html_document: default
---

```{r setup, include=FALSE}

processdata <- 0  # this flag determines the amount of processing, with 4 levels:
# 0 - do no processing, generate the pdf using existing versions of all scripts
# 1 - generate figures using the processed group data (requires XGB of storage)
# 2 - download processed individual data and analyse (requires XGB of storage)
# 3 - download all raw data and analyse (requires XGB of storage)

plotsmoothed <- 1 # either plot the raw data (0), or a smoothed spline (1)

# reasonably compact code to check which packages are installed, install the missing ones, and activate all
packagelist <- c('knitr','remotes','tictoc','R.matlab','bookdown','grImport','tiff','pals') # list of CRAN packages
missingpackages <- packagelist[!packagelist %in% installed.packages()[,1]]
if (length(missingpackages)>0){install.packages(missingpackages)}
if (!'osfr' %in% installed.packages()[,1]){remotes::install_github("centerforopenscience/osfr")}
if (!'FourierStats' %in% installed.packages()[,1]){remotes::install_github("bakerdh/FourierStats")}
packagelist <- c(packagelist,'osfr','FourierStats')
toinstall <- packagelist[which(!packagelist %in% (.packages()))]
invisible(lapply(toinstall,library,character.only=TRUE))

osf_auth(token = '3dEYuhZNmwWbG3xuhRIiVRo0T2oniOkEP3Ip8i1LPG4PNjeTRln54eGNAG7oyTT9xozWwJ')

# helper function to make colours transparent
addalpha <- function(col, alpha=1){apply(sapply(col, col2rgb)/255, 2, function(x) rgb(x[1], x[2], x[3], alpha=alpha))}


v4Interp <- function(df, xo, yo, rmax = .75, gridRes = 67) {
  ## Create a function to perform Matlab's v4 interpolation.
  ## Takes as input a data-frame with columns x, y, and z (x co-ordinates, y co-ordinates, and amplitude)
  ## and variables xo and yo, the co-ordinates which will be use to create a grid for interpolation
  xo <- matrix(rep(xo,length(yo)),nrow = length(xo),ncol = length(yo))
  yo <- t(matrix(rep(yo,length(xo)),nrow = length(yo),ncol = length(xo)))
  xy <- df$x + df$y*sqrt(as.complex(-1))
  d <- matrix(rep(xy,length(xy)),nrow = length(xy), ncol = length(xy))
  d <- abs(d - t(d))
  diag(d) <- 1
  g <- (d^2) * (log(d)-1)   # Green's function.
  diag(g) <- 0
  weights <- qr.solve(g,df$z)
  xy <- t(xy)
  outmat <- matrix(nrow = gridRes,ncol = gridRes)
  for (i in 1:gridRes){
    for (j in 1:gridRes) {
      test4 <- abs((xo[i,j] + sqrt(as.complex(-1))*yo[i,j]) - xy)
      g <- (test4^2) * (log(test4)-1)
      outmat[i,j] <- g %*% weights}}
  outDf <- data.frame(x = xo[,1],outmat)
  names(outDf)[1:length(yo[1,])+1] <- yo[1,]
  return(outDf)}

scoreAQ <- function(qdata){
# score the AQ questionnaire
# input is a row from a spreadsheet indicating responses to 50 questions
AQanswers <- toupper(c('(1) Definitely agree','(2) Slightly agree', '(3) Slightly disagree', '(4) Definitely disagree'))
reverseitems <- rep(0,50)
 # reverse scored questionnaire items
reverseitems[c(3,8,10,11,14,15,17,24,25,27,28,29,30,31,32,34,36,37,38,40,44,47,48,49,50)] <- 1 

  thisAQ <- 0
  nansweredAQ <- 0
  for (q in 1:50){
    response <- which(AQanswers==toupper(as.character(qdata[1,q])))
    if (length(response)>0){
      nansweredAQ <- nansweredAQ + 1
      if (reverseitems[q]==0){response <- 5 - response}
      if (response>2){thisAQ <- thisAQ + 1}
    }}
thisAQ <- round(50*thisAQ/nansweredAQ)    
return(thisAQ)}

scoreAQshort <- function(qdata){
# score the AQ questionnaire - short version
# input is a row from a spreadsheet indicating responses to 28 questions
AQanswers <- toupper(c('(1) Definitely agree','(2) Slightly agree', '(3) Slightly disagree', '(4) Definitely disagree'))
reverseitems <- rep(0,28)
 # reverse scored questionnaire items
reverseitems[c(7, 50, 52, 54, 55, 58, 59, 62, 63, 64, 65, 66, 67, 69, 72)] <- 1 

  thisAQ <- 0
  nansweredAQ <- 0
  for (q in 1:28){
    response <- which(AQanswers==toupper(as.character(qdata[1,q])))
    if (length(response)>0){
      nansweredAQ <- nansweredAQ + 1
      if (reverseitems[q]==0){response <- 5 - response}
      if (response>2){thisAQ <- thisAQ + 1}
    }}
thisAQ <- round(50*thisAQ/nansweredAQ)    
return(thisAQ)}

knitr::opts_chunk$set(echo = TRUE)
colpal <- c('#000000','#8783CF','#FE5000','#228B22','#8B8000')

# check if directories exist to store data files (ignored by git)
if (!dir.exists('temp/')){dir.create('temp/')}
if (!dir.exists('temp/figures/')){dir.create('temp/figures/')}
if (!dir.exists('temp/VilidaiteProcessed/')){dir.create('temp/VilidaiteProcessed/')}
if (!dir.exists('temp/raw/')){dir.create('temp/raw/')}
if (!dir.exists('temp/raw/temp/')){dir.create('temp/raw/temp/')}
if (!dir.exists('temp/MEGdata/')){dir.create('temp/MEGdata/')}
if (!dir.exists('temp/EEGprocessed/')){dir.create('temp/EEGprocessed/')}

targetelectrodes <- c('Oz','POz','O1','O2')

hdata <- read.csv('~/Google Drive/Current work/R scripts/EEG analysis/headerfile.csv', header = TRUE)

```

## Abstract

For decades, neural suppression in early visual cortex has been thought to be fixed. But recent work has challenged this assumption by showing that suppression can be \emph{reweighted} based on recent history; when pairs of stimuli are repeatedly presented together, suppression between them strengthens. Here we investigate the temporal dynamics of this process using a steady-state VEP paradigm that provides a time-resolved, direct index of suppression between pairs of stimuli flickering at different frequencies (5 and 7Hz). Our initial analysis of an existing EEG dataset (N=100) indicated that suppression increases substantially during the first 4 seconds of stimulus presentation. We then collected new EEG data (N=100) replicating this finding for both monocular and dichoptic mask arrangements in a preregistered study designed to measure reweighting. A third experiment (N=20) use source localized MEG, and found that suppression increases across the visual hierarchy, and that reweighting is more rapid in dorsal compared with ventral visual areas. Because long-standing theories propose inhibition/excitation differences in autism, we also compared reweighting between individuals with high vs low autistic traits, and with and without an autism diagnosis, across our 3 data sets (total N=220). We find . . .


## Introduction

Suppressive interactions between neurons are ubiquitous in the nervous system, and normalization (or gain control) processes are considered a canonical neuronal computation (Carandini & Heeger). Yet the strength of suppression was for decades treated as fixed, largely due to the observation that adapting to one stimulus does not decrease its suppressive potency (refs). This orthodoxy was recently challenged by a series of innovative studies showing that normalization can be 'reweighted' by recent history (Westrick, Aschner, Yiltiz). Specifically, when pairs of stimuli are repeatedly presented together, they come to suppress each other more strongly. This suggests that, far from being fixed, normalization is a dynamic process that is continuously updated by the sensory environment. Here, our objectives were to determine if the timecourse of these changes can be measured non-invasively from the human brain, assess if they occur across suppressive pathways, and determine whether they differ across the population as a function of autistic traits.

Atypical sensory experience is widely reported by individuals on the autism spectrum, but the causal mechanisms remain unclear. Typical issues include hypersensitivity to intense stimuli such as loud sounds, bright lights and strong odours or flavours. Yet fundamental measures of sensitivity such as visual acuity, contrast sensitivity, and audiometric performance (Rosenhall et al. 1999) are not consistently different from neurotypical controls. Theoretical accounts of sensory differences in autism have long proposed that the balance of inhibition and excitation may be disrupted, and there are isolated results that seem consistent with this. For example 
However many other studies have failed to find group differences using tasks that are at least superficially dependent on inhibition, such as...


A comprehensive review of the literature on vision in autism (Simmons et al., 2009)


Our recent work has identified a potential autism-related difference in gain control using steady-state EEG methods. Vilidaite et al. (2018) measured contrast response functions for flickering stimuli in a large group of neurotypical adults, who were split by their autism quotient (AQ; Baron-Cohen et al., 2001) score. The responses were comparable between high and low AQ groups at the flicker frequency of the stimulus. However at the second harmonic frequency (twice the flicker frequency), the high AQ group showed weaker responses than the low AQ group. This effect was replicated in an independent sample of 12 adults with an autism diagnosis (compared with neurotypical controls). Because second harmonic responses are caused by nonlinear interactions in the visual system (they are absent in a linear system), this potentially implicates differences in divisive suppression in autism. Furthermore, there appears to be a developmental trajectory, as autistic children tested as part of the same study (Vilidaite et al., 2018) showed weaker responses at both the first and second harmonic frequencies.

Suppression itself is not a single process. Multiple suppressive pathways have been identified in the visual system, including between stimuli differing in orientation, eye-of-origin and spatial position. At present there is evidence of normalization reweighting between stimuli of orthogonal orientations (Aschner, 2018), and adjacent spatial positions (Yiltiz, 2020). We also wondered if interocular suppression might be subject to reweighting, and if there are differences in the dynamics across pathways. This is possible, given that suppression within and between the eyes has different spatiotemporal tuning (Meese & Baker, 2009), and dichoptic masking can be reduced by adapting to the mask (Baker, 2007 and other studies), unlike within-eye masking. Dynamic fluctuations in interocular suppression are a feature of binocular rivalry (Wilson, 2003; Alais et al., 2006), for which differences in autism have also been reported (Robertson). 

We hypothesised that normalization reweighting might differ as a function of autistic traits. The relative novelty of the reweighting framework could explain why any differences have not previously been detected, and why the literature on inhibition in autism is relatively inconclusive. In this paper we perform a time-course analysis of a previously published EEG data set, and report two novel pre-registered experiments using EEG and MEG. Our data show that suppression increases substantially during the first 6 seconds after stimulus onset, for both monocular and dichoptic masks. The timecourse of reweighting is slower in ventral brain regions, and more rapid in dorsal parts of the visual pathway. Autism ...


## Results

We began by reanalysing data from a steady-state visually evoked potential (SSVEP) experiment reported by Vilidaite et al (2018). Participants viewed arrays of flickering gratings of varying contrasts. In some conditions a single grating orientation was present flickering at 7Hz, whereas in other conditions a high contrast 'mask' was added at right angles to the target gratings, and flickering at 5Hz. The left panel of Figure \@ref(fig:Pilotdata)a shows contrast response functions with and without the mask - the presence of the mask reduces the 7Hz response to the target (blue squares are below the black circles). Similarly, the right panel of Figure \@ref(fig:Pilotdata)a shows that the 5Hz response to the mask was itself suppressed by the presence of high contrast targets (note that the data from the mask conditions were not reported by Vilidaite et al.). At both frequencies, responses were localised to the occipital pole (see insets).

We then performed a timecourse analysis, in which we analysed each 11-second trial using a sliding 1-second time window. Figure \@ref(fig:Pilotdata)c shows the response at the target frequency (7Hz) to a single stimulus of 32% contrast (black), and the response at 7Hz when the mask is added (blue). Analogous responses are shown at three other frequencies - the mask frequency (5Hz), and the second harmonics of both target and mask frequencies (14Hz, 10Hz), at which strong responses were also found (see spectra in Figure \@ref(fig:Pilotdata)b). The reduction in signal strength when the mask component is added illustrates the masking effect. Taking the ratio of the two timecourses to calculate a masking index reveals that masking increases steeply during the first two seconds of stimulus presentation, and then plateaus for several seconds (blue trace in Figure \@ref(fig:Pilotdata)d). A similar pattern is observed at 5Hz (red trace in Figure \@ref(fig:Pilotdata)d), with the increase continuing for around four seconds, as well as at the second harmonics. The black trace shows the average masking ratio across all four frequencies, which rises steeply for just over two seconds, mor gradually for a further two seconds, and then stays approximately constant.

```{r include=FALSE, results='hide'}

samplerate <- 1000
targetF <- 7
maskF <- 5
tindex <- (10*targetF) + 1
mindex <- (10*maskF) + 1
duration <- 14

    binwidth <- 1000
    findex <- 1 + targetF*(binwidth/1000)
    findex[2] <- 1 + maskF*(binwidth/1000)
    findex[3] <- 1 + 2*targetF*(binwidth/1000)
    findex[4] <- 1 + 2*maskF*(binwidth/1000)
    
condlist <- c(6,8,13)

if (processdata>2){
  
osfnode <- 'y4n5k'    # this is where the pilot data are stored
osfproject <- osf_retrieve_node(osfnode)
EEGfiles <- osf_ls_files(osfproject,n_max=300)

# datadir <- '/Volumes/Seagate/EEG data/UG2014/tar/'
# tempdir <- '/Volumes/Seagate/EEG data/UG2014/tar/temp/'
datadir <- 'temp/raw/'
tempdir <- 'temp/raw/temp/'

hdata <- read.csv('~/Google Drive/Current work/R scripts/EEG analysis/headerfile.csv', header = TRUE)
legaltriggers <- hdata$Trigger[!is.na(hdata$Trigger)]
subjcounter <- 0

for (s in 1:101) {
  if (s != 75) {
    subjcounter <- subjcounter + 1  
  if (!file.exists(paste0('temp/VilidaiteProcessed/V',subjcounter,'processed.RData'))){
  print(s)
    
    if (s < 10){tarname <- paste0('S0', s, '.tar')}
    if (s > 9){tarname <- paste0('S', s, '.tar')}
    
    if (!file.exists(paste0(datadir,tarname))){
      fid <- which(EEGfiles$name==tarname)
      osf_download(EEGfiles[fid,],datadir,progress=TRUE)
    }
    
    condcounter <- (1:20) * 0
    allsamples <- array(0, dim = c(10,20,64,duration*samplerate))

    untar(paste0(datadir,tarname),exdir=tempdir)

    condcounter <- (1:20) * 0
    allsamples <- array(0, dim = c(10,20,64,duration*samplerate))
    if (s < 10){d <- dir(path = paste0(tempdir,'S0',s), pattern='*.csv.gz',full.names=TRUE)}
    if (s > 9){d <- dir(path = paste0(tempdir,'S',s), pattern='*.csv.gz',full.names=TRUE)}
    
    d <- dir(path = tempdir, pattern = '*.csv.gz')
    
    for (block in 1:length(d)) {
      EEGdata <- read.csv(d[block], header = TRUE)
      
      electrodes <- colnames(EEGdata)
      targetchannels <- match(targetelectrodes, electrodes) - 2
      
      # epoch the data, Fourier transform and store
      triggertimes <- (1:40) * 0
      counter <- 0
      for (n in 1500:nrow(EEGdata)) {    # ignore triggers starting in the first 1000ms that generate an error
        if (EEGdata$Trigger[n] %in% legaltriggers) {
          counter <- counter + 1
          triggertimes[counter] <- n
      }
      }
      
      for (tr in 1:counter) {
        cond <- EEGdata$Trigger[triggertimes[tr]] / 10
        condcounter[cond] <- condcounter[cond] + 1
        for (ch in 1:64){
        temp <- as.matrix(EEGdata[(triggertimes[tr]:(triggertimes[tr] + samplerate * duration - 1))-1499, ch + 2])
        temp <- temp - mean(temp[501:1500])
        allsamples[condcounter[cond],cond,ch,1:(1000*duration)] <- as.vector(rowMeans(temp))
        }
      }
    }
allsamples[which(is.na(allsamples))] <- 0     # remove any NaN values
meanwaveforms <- array(0,dim=c(14,64,14000))
trialsincluded <- matrix(0,nrow=14,ncol=64)
    for (cond in 1:14){
      for (ch in 1:64){
        temp <- allsamples[1:condcounter[cond],cond,ch,]
        allspec <- matrix(0,nrow=condcounter[cond],ncol=10000)
        for (trial in 1:condcounter[cond]){
          allspec[trial,] <- fft(temp[trial,2501:12500])/10000
        }
        targetresps <- allspec[,tindex]
        maskresps <- allspec[,mindex]
      if (sum(abs(targetresps))>0){  
      tempxy <- data.frame(Re(targetresps),Im(targetresps))
      D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      i1 <- (D<3)
      tempxy <- data.frame(Re(maskresps),Im(maskresps))
      D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      i2 <- (D<3)
      i <- which((i1*i2)>0)
        meanwaveforms[cond,ch,] <- colMeans(temp[i,])
        trialsincluded[cond,ch] <- length(i)
      }
      }
    }
    
     save(file = paste0('temp/VilidaiteProcessed/V',subjcounter,'processed.RData'), list = c('meanwaveforms','electrodes','trialsincluded'))
     
    for (block in 1:length(d)){file.remove(d[block])}

  }
}
}
}

if (processdata>1){

d <- dir(path = 'temp/VilidaiteProcessed', pattern = '*.RData', full.names=TRUE)
EEGtimecourse <- array(0,dim=c(length(d),length(findex),3,13000))
EEGspectra <- array(0,dim=c(length(d),3,20*10))
EEGscalpresps <- array(0,dim=c(length(d),4,14,64))
EEGallconds <- array(0,dim=c(length(d),4,14))

for (s in 1:length(d)){
  load(d[s])
  targetchannels <- match(targetelectrodes, electrodes) - 2
  
  for (cond in 1:14){
    temp <- colMeans(meanwaveforms[cond,targetchannels,],na.rm=TRUE)
        nainds <- which(is.na(temp))   # find occasional NaN values in the waveform
    temp[nainds] <- 0   # replace with zeros
    spec <- fft(temp[2501:12500])/10000
    EEGallconds[s,1,cond] <- spec[1+(10*targetF)]
    EEGallconds[s,2,cond] <- spec[1+(10*maskF)]
    EEGallconds[s,3,cond] <- spec[1+(2*10*targetF)]
    EEGallconds[s,4,cond] <- spec[1+(2*10*maskF)]
  }
  for (cond in 1:3){
    temp <- colMeans(meanwaveforms[condlist[cond],targetchannels,],na.rm=TRUE)
    nainds <- which(is.na(temp))   # find occasional NaN values in the waveform
    temp[nainds] <- 0   # replace with zeros

    spec <- fft(temp[2501:12500])/10000
    EEGspectra[s,cond,] <- spec[1:(20*10)]
    
for (t in 1:(14000-binwidth)){
  spec <- fft(temp[t:(t+binwidth-1)])/binwidth
  for (f in 1:length(findex)){
  EEGtimecourse[s,f,cond,t] <- spec[findex[f]]
  }
}
  } 
  
for (cond in 1:14){
  for (ch in 1:64){
     temp <- meanwaveforms[cond,ch,]
    nainds <- which(is.na(temp))   # find occasional NaN values in the waveform
    temp[nainds] <- 0   # replace with zeros
   spec <- fft(temp[2501:12500])/10000
   EEGscalpresps[s,1,cond,ch] <- spec[(targetF*10)+1]
   EEGscalpresps[s,2,cond,ch] <- spec[(maskF*10)+1]
   EEGscalpresps[s,3,cond,ch] <- spec[(2*targetF*10)+1]
   EEGscalpresps[s,4,cond,ch] <- spec[(2*maskF*10)+1]
  }
}  
  
  
  
}

save(file='temp/Pilotsummary.RData',list=c('EEGtimecourse','electrodes','EEGscalpresps','EEGspectra','EEGallconds'))
}

if (processdata>0){
  
load('temp/Pilotsummary.RData')
nsubjs <- dim(EEGtimecourse)[1]
EEGmeantimes <- array(0,dim=c(length(findex),3,13000))
EEGSEtimes <- array(0,dim=c(length(findex)+1,3,13000))
EEGmaskindices <- array(0,dim=c(length(findex)+1,13000))
EEGmaskSE <- array(0,dim=c(length(findex)+1,13000))
EEGmeanscalp <- abs(apply(abs(EEGscalpresps),2:4,mean))
EEGmeanspec <- abs(apply(abs(EEGspectra),2:3,mean))
EEGmeanconds <- apply(abs(EEGallconds),2:3,mean)
EEGcondsSE <- apply(abs(EEGallconds),2:3,sd)/sqrt(nsubjs)

for (f in 1:length(findex)){
for (cond in 1:3){
EEGmeantimes[f,cond,] <- apply(abs(EEGtimecourse[,f,cond,]),2,mean,na.rm=TRUE)
EEGSEtimes[f,cond,] <- apply(abs(EEGtimecourse[,f,cond,]),2,sd,na.rm=TRUE)/sqrt(nsubjs)
}}


EEGmaskindices[1,] <- colMeans(20*log10(abs(EEGtimecourse[,1,1,])/abs(EEGtimecourse[,1,3,])))
EEGmaskindices[2,] <- colMeans(20*log10(abs(EEGtimecourse[,2,2,])/abs(EEGtimecourse[,2,3,])))
EEGmaskindices[3,] <- colMeans(20*log10(abs(EEGtimecourse[,3,1,])/abs(EEGtimecourse[,3,3,])))
EEGmaskindices[4,] <- colMeans(20*log10(abs(EEGtimecourse[,4,2,])/abs(EEGtimecourse[,4,3,])))


meanindices <- (20*log10(abs(EEGtimecourse[,1,1,])/abs(EEGtimecourse[,1,3,])) + 20*log10(abs(EEGtimecourse[,2,2,])/abs(EEGtimecourse[,2,3,])) + 20*log10(abs(EEGtimecourse[,3,1,])/abs(EEGtimecourse[,3,3,])) + 20*log10(abs(EEGtimecourse[,4,2,])/abs(EEGtimecourse[,4,3,])))/4
EEGmaskindices[5,] <- colMeans(meanindices)


EEGmaskSE[1,] <- apply(20*log10(abs(EEGtimecourse[,1,1,])/abs(EEGtimecourse[,1,3,])),2,sd)/sqrt(nsubjs)
EEGmaskSE[2,] <- apply(20*log10(abs(EEGtimecourse[,2,2,])/abs(EEGtimecourse[,2,3,])),2,sd)/sqrt(nsubjs)
EEGmaskSE[3,] <- apply(20*log10(abs(EEGtimecourse[,3,1,])/abs(EEGtimecourse[,3,3,])),2,sd)/sqrt(nsubjs)
EEGmaskSE[4,] <- apply(20*log10(abs(EEGtimecourse[,4,2,])/abs(EEGtimecourse[,4,3,])),2,sd)/sqrt(nsubjs)
EEGmaskSE[5,] <- apply(meanindices,2,sd)/sqrt(nsubjs)


times <- (-999:12000)/1000

postscript("timecourse1.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,12,0,1)
ticklocsx <- c(-1,seq(0,12,2))    # locations of tick marks on y axis
ticklocsy <- seq(0,1,0.2)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = seq(0,12,2), side = 1, at=seq(0,12,2))
mtext(text = ticklocsy, side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,11,11,0),c(-0.035,-0.035,0.04,0.04),border=NA,col=rgb(0.5,0.5,0.5))

if (plotsmoothed==0){
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[1,1,]+EEGSEtimes[1,1,],EEGmeantimes[1,1,13000:1]-EEGSEtimes[1,1,13000:1]),col=colpal[1],border=NA)
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[1,2,]+EEGSEtimes[1,2,],EEGmeantimes[1,2,13000:1]-EEGSEtimes[1,2,13000:1]),col='grey',border=NA)
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[1,3,]+EEGSEtimes[1,3,],EEGmeantimes[1,3,13000:1]-EEGSEtimes[1,3,13000:1]),col=colpal[2],border=NA)

lines(times,EEGmeantimes[1,1,],col=colpal[1])
lines(times,EEGmeantimes[1,2,],col='grey')
lines(times,EEGmeantimes[1,3,],col=colpal[2])
}
if (plotsmoothed==1){
  
spl5aU <- smooth.spline(times,EEGmeantimes[1,1,]+EEGSEtimes[1,1,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[1,1,]-EEGSEtimes[1,1,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[1],border=NA)

spl5aU <- smooth.spline(times,EEGmeantimes[1,2,]+EEGSEtimes[1,2,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[1,2,]-EEGSEtimes[1,2,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col='grey',border=NA)

spl5aU <- smooth.spline(times,EEGmeantimes[1,3,]+EEGSEtimes[1,3,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[1,3,]-EEGSEtimes[1,3,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[2],border=NA)

spl5a <- smooth.spline(times,EEGmeantimes[1,1,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[1],lwd=2)
spl5a <- smooth.spline(times,EEGmeantimes[1,2,],df=20)
lines(spl5a$x,spl5a$y,col='grey',lwd=2)
spl5a <- smooth.spline(times,EEGmeantimes[1,3,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[2],lwd=2)
}
text(10,0.95,'7Hz',cex=2)

dev.off()

postscript("timecourse2.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = seq(0,12,2), side = 1, at=seq(0,12,2))
mtext(text = ticklocsy, side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,11,11,0),c(-0.035,-0.035,0.04,0.04),border=NA,col=rgb(0.5,0.5,0.5))

if (plotsmoothed==0){
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[2,2,]+EEGSEtimes[2,2,],EEGmeantimes[2,2,13000:1]-EEGSEtimes[2,2,13000:1]),col=colpal[1],border=NA)
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[2,1,]+EEGSEtimes[2,1,],EEGmeantimes[2,1,13000:1]-EEGSEtimes[2,1,13000:1]),col='grey',border=NA)
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[2,3,]+EEGSEtimes[2,3,],EEGmeantimes[2,3,13000:1]-EEGSEtimes[2,3,13000:1]),col=colpal[2],border=NA)

lines(times,EEGmeantimes[2,2,],col=colpal[1])
lines(times,EEGmeantimes[2,1,],col='grey')
lines(times,EEGmeantimes[2,3,],col=colpal[2])
}
if (plotsmoothed==1){
  
spl5aU <- smooth.spline(times,EEGmeantimes[2,2,]+EEGSEtimes[2,2,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[2,2,]-EEGSEtimes[2,2,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[1],border=NA)

spl5aU <- smooth.spline(times,EEGmeantimes[2,1,]+EEGSEtimes[2,1,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[2,1,]-EEGSEtimes[2,1,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col='grey',border=NA)

spl5aU <- smooth.spline(times,EEGmeantimes[2,3,]+EEGSEtimes[2,3,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[2,3,]-EEGSEtimes[2,3,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[2],border=NA)

spl5a <- smooth.spline(times,EEGmeantimes[2,2,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[1],lwd=2)
spl5a <- smooth.spline(times,EEGmeantimes[2,1,],df=20)
lines(spl5a$x,spl5a$y,col='grey',lwd=2)
spl5a <- smooth.spline(times,EEGmeantimes[2,3,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[2],lwd=2)
}
text(10,0.95,'5Hz',cex=2)

dev.off()

postscript("timecourse3.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = seq(0,12,2), side = 1, at=seq(0,12,2))
mtext(text = ticklocsy, side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,11,11,0),c(-0.035,-0.035,0.04,0.04),border=NA,col=rgb(0.5,0.5,0.5))

if (plotsmoothed==0){
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[3,1,]+EEGSEtimes[3,1,],EEGmeantimes[3,1,13000:1]-EEGSEtimes[3,1,13000:1]),col=colpal[1],border=NA)
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[3,2,]+EEGSEtimes[3,2,],EEGmeantimes[3,2,13000:1]-EEGSEtimes[3,2,13000:1]),col='grey',border=NA)
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[3,3,]+EEGSEtimes[3,3,],EEGmeantimes[3,3,13000:1]-EEGSEtimes[3,3,13000:1]),col=colpal[2],border=NA)

lines(times,EEGmeantimes[3,1,],col=colpal[1])
lines(times,EEGmeantimes[3,2,],col='grey')
lines(times,EEGmeantimes[3,3,],col=colpal[2])
}
if (plotsmoothed==1){
  
spl5aU <- smooth.spline(times,EEGmeantimes[3,1,]+EEGSEtimes[3,1,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[3,1,]-EEGSEtimes[3,1,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[1],border=NA)

spl5aU <- smooth.spline(times,EEGmeantimes[3,2,]+EEGSEtimes[3,2,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[3,2,]-EEGSEtimes[3,2,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col='grey',border=NA)

spl5aU <- smooth.spline(times,EEGmeantimes[3,3,]+EEGSEtimes[3,3,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[3,3,]-EEGSEtimes[3,3,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[2],border=NA)

spl5a <- smooth.spline(times,EEGmeantimes[3,1,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[1],lwd=2)
spl5a <- smooth.spline(times,EEGmeantimes[3,2,],df=20)
lines(spl5a$x,spl5a$y,col='grey',lwd=2)
spl5a <- smooth.spline(times,EEGmeantimes[3,3,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[2],lwd=2)
}
text(10,0.95,'14Hz',cex=2)

dev.off()

postscript("timecourse4.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = seq(0,12,2), side = 1, at=seq(0,12,2))
mtext(text = ticklocsy, side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,11,11,0),c(-0.035,-0.035,0.04,0.04),border=NA,col=rgb(0.5,0.5,0.5))

if (plotsmoothed==0){
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[4,2,]+EEGSEtimes[4,2,],EEGmeantimes[4,2,13000:1]-EEGSEtimes[4,2,13000:1]),col=colpal[1],border=NA)
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[4,1,]+EEGSEtimes[4,1,],EEGmeantimes[4,1,13000:1]-EEGSEtimes[4,1,13000:1]),col='grey',border=NA)
polygon(times[c(1:13000,13000:1)],c(EEGmeantimes[4,3,]+EEGSEtimes[4,3,],EEGmeantimes[4,3,13000:1]-EEGSEtimes[4,3,13000:1]),col=colpal[2],border=NA)

lines(times,EEGmeantimes[4,2,],col=colpal[1])
lines(times,EEGmeantimes[4,1,],col='grey')
lines(times,EEGmeantimes[4,3,],col=colpal[2])
}
if (plotsmoothed==1){
  
spl5aU <- smooth.spline(times,EEGmeantimes[4,2,]+EEGSEtimes[4,2,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[4,2,]-EEGSEtimes[4,2,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[1],border=NA)

spl5aU <- smooth.spline(times,EEGmeantimes[4,1,]+EEGSEtimes[4,1,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[4,1,]-EEGSEtimes[4,1,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col='grey',border=NA)

spl5aU <- smooth.spline(times,EEGmeantimes[4,3,]+EEGSEtimes[4,3,],df=20)
spl5aL <- smooth.spline(times,EEGmeantimes[4,3,]-EEGSEtimes[4,3,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[2],border=NA)

spl5a <- smooth.spline(times,EEGmeantimes[4,2,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[1],lwd=2)
spl5a <- smooth.spline(times,EEGmeantimes[4,1,],df=20)
lines(spl5a$x,spl5a$y,col='grey',lwd=2)
spl5a <- smooth.spline(times,EEGmeantimes[4,3,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[2],lwd=2)
}
text(10,0.95,'10Hz',cex=2)

dev.off()


postscript("suppression.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,12,-3,6)
ticklocsx <- c(-1,seq(0,12,2))    # locations of tick marks on y axis
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = seq(0,12,2), side = 1, at=seq(0,12,2))
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,11,11,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,12),c(0,0),lty=2)

if (plotsmoothed==0){
  
# for (f in 1:4){
# polygon(times[c(1:13000,13000:1)],c(EEGmaskindices[f,]+EEGmaskSE[f,],EEGmaskindices[f,13000:1]-EEGmaskSE[f,13000:1]),col=colpal[f+1],border=NA)
# }
  polygon(times[c(1:13000,13000:1)],c(EEGmaskindices[5,]+EEGmaskSE[5,],EEGmaskindices[5,13000:1]-EEGmaskSE[5,13000:1]),col=colpal[1],border=NA)

for (f in 1:4){lines(times,EEGmaskindices[f,],col=colpal[f+1])}
lines(times,EEGmaskindices[5,],col=colpal[1],lwd=4)
}

if (plotsmoothed==1){
# for (f in 1:4){  
# spl5aU <- smooth.spline(times,EEGmaskindices[f,]+EEGmaskSE[f,],df=20)
# spl5aL <- smooth.spline(times,EEGmaskindices[f,]-EEGmaskSE[f,],df=20)
# polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[f+1],border=NA)
# }
  spl5aU <- smooth.spline(times,EEGmaskindices[5,]+EEGmaskSE[5,],df=20)
spl5aL <- smooth.spline(times,EEGmaskindices[5,]-EEGmaskSE[5,],df=20)
polygon(times[c(1:13000,13000:1)],c(spl5aU$y,spl5aL$y[13000:1]),col=colpal[1],border=NA)

for (f in 1:4){
spl5a <- smooth.spline(times,EEGmaskindices[f,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[f+1],lwd=2)
}
spl5a <- smooth.spline(times,EEGmaskindices[5,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[1],lwd=6)
}
legend(1,0,c('7Hz','5Hz'),lwd=4,col=colpal[c(2,3)],bty='n')
legend(5,0,c('14Hz','10Hz'),lwd=4,col=colpal[c(4,5)],bty='n')
legend(3,-1.4,c('Mean'),lwd=6,col=colpal[1],bty='n')

dev.off()


freqlist <- seq(0,19.9,1/10)

postscript("spectrum.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 10)

plotlims <- c(0,20,0,3)  # define the x and y limits of the plot (minx,maxx,miny,maxy)
ticklocsx <- seq(0,20,5)    # locations of tick marks on x axis
ticklocsy <- c(0,0.4,0.8,1,2,3)    # locations of tick marks on y axis
ticklabelsx <- seq(0,20,5)        # set labels for x ticks
ticklabelsy <- c(0,0.2,0.4,'','','')    # set labels for y ticks
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])   
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)     # plot tick marks (no labels)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklabelsx, side = 1, at=ticklocsx)     # add the tick labels
mtext(text = ticklabelsy, side = 2, at=ticklocsy, line=0.2, las=1) 
title(xlab="Frequency (Hz)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    # titles for axes
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

lines(c(0,20),c(0,0),lty=3)
lines(c(0,20),c(1,1),lty=3)
lines(c(0,20),c(2,2),lty=3)

polygon(c(freqlist[11],freqlist[11:200],19.9),c(0,2*EEGmeanspec[1,11:200],0)+2,border=NA,col=colpal[1])
polygon(c(freqlist[11],freqlist[11:200],19.9),c(0,2*EEGmeanspec[2,11:200],0)+1,border=NA,col=colpal[2])
polygon(c(freqlist[11],freqlist[11:200],19.9),c(0,2*EEGmeanspec[3,11:200],0),border=NA,col=colpal[3])

lines(freqlist[11:200],2*EEGmeanspec[1,11:200]+2,lwd=2,col='black')
lines(freqlist[11:200],2*EEGmeanspec[2,11:200]+1,lwd=2,col='black')
lines(freqlist[11:200],2*EEGmeanspec[3,11:200],lwd=2,col='black')

text(20,2.5,'7Hz target',pos=2,cex=1.5)
text(20,1.5,'5Hz mask',pos=2,cex=1.5)
text(20,0.5,'Plaid',pos=2,cex=1.5)

dev.off()



postscript("CRFs.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 9)

contrastsdB <- seq(0,36,6)

plotlims <- c(0,78,0,0.8)
ticklocsx <- seq(0,36,6)    # locations of tick marks on y axis
ticklocsy <- seq(0,0.8,0.2)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = c(0,2,4,8,16,32,64), side = 1, at=ticklocsx)
mtext(text = ticklocsy, side = 2, at=ticklocsy, line=0.2, las=1)
axis(1, at=ticklocsx+42, tck=0.01, lab=F, lwd=2)
mtext(text = c(0,2,4,8,16,32,64), side = 1, at=ticklocsx+42)
title(xlab="Target contrast (%)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

arrows(contrastsdB,EEGmeanconds[1,1:7],contrastsdB,EEGmeanconds[1,1:7]+EEGcondsSE[1,1:7],lwd=2,angle=90,length=0.015,col=colpal[1])
arrows(contrastsdB,EEGmeanconds[1,1:7],contrastsdB,EEGmeanconds[1,1:7]-EEGcondsSE[1,1:7],lwd=2,angle=90,length=0.015,col=colpal[1])

arrows(contrastsdB,EEGmeanconds[1,8:14],contrastsdB,EEGmeanconds[1,8:14]+EEGcondsSE[1,8:14],lwd=2,angle=90,length=0.015,col=colpal[2])
arrows(contrastsdB,EEGmeanconds[1,8:14],contrastsdB,EEGmeanconds[1,8:14]-EEGcondsSE[1,8:14],lwd=2,angle=90,length=0.015,col=colpal[2])

lines(contrastsdB,EEGmeanconds[1,1:7],lwd=2,col=colpal[1])
lines(contrastsdB,EEGmeanconds[1,8:14],lwd=2,col=colpal[2])

points(contrastsdB,EEGmeanconds[1,1:7],pch=16,cex=1.5,col=colpal[1])
points(contrastsdB,EEGmeanconds[1,8:14],pch=15,cex=1.5,col=colpal[2])

points(contrastsdB[6],EEGmeanconds[1,6],pch=16,cex=2.5,col=colpal[1])
points(contrastsdB[6],EEGmeanconds[1,13],pch=15,cex=2.5,col=colpal[2])


contrastsdB <- contrastsdB+42

arrows(contrastsdB,EEGmeanconds[2,1:7],contrastsdB,EEGmeanconds[2,1:7]+EEGcondsSE[2,1:7],lwd=2,angle=90,length=0.015,col=colpal[1])
arrows(contrastsdB,EEGmeanconds[2,1:7],contrastsdB,EEGmeanconds[2,1:7]-EEGcondsSE[2,1:7],lwd=2,angle=90,length=0.015,col=colpal[1])

arrows(contrastsdB,EEGmeanconds[2,8:14],contrastsdB,EEGmeanconds[2,8:14]+EEGcondsSE[2,8:14],lwd=2,angle=90,length=0.015,col=colpal[2])
arrows(contrastsdB,EEGmeanconds[2,8:14],contrastsdB,EEGmeanconds[2,8:14]-EEGcondsSE[2,8:14],lwd=2,angle=90,length=0.015,col=colpal[2])

lines(contrastsdB,EEGmeanconds[2,1:7],lwd=2,col=colpal[1])
lines(contrastsdB,EEGmeanconds[2,8:14],lwd=2,col=colpal[2])

points(contrastsdB,EEGmeanconds[2,1:7],pch=16,cex=1.5,col=colpal[1])
points(contrastsdB,EEGmeanconds[2,8:14],pch=15,cex=1.5,col=colpal[2])

points(contrastsdB[1],EEGmeanconds[2,8],pch=15,cex=2.5,col=colpal[2])
points(contrastsdB[6],EEGmeanconds[2,13],pch=15,cex=2.5,col=colpal[2])

text(18,0.78,'7Hz response',cex=2,adj=0.5)
text(42+18,0.78,'5Hz response',cex=2,adj=0.5)

legend(65,0.7,c('Target','Target+mask'),pch=16:15,col=colpal[1:2],bty='n')

dev.off()


xpos <- 1:64
ypos <- 1:64
montageE <- toupper(as.character(hdata$Electrode))
for (ch in 1:64){
  i <- match(toupper(electrodes[ch+2]),montageE)
  xpos[ch] <- hdata$X_position[i]
  ypos[ch] <- hdata$Y_position[i]
}


for (f in 1:2){
rmax <- 0.55   #specify a maximum boundary for the grid
gridRes <- 100 #specify the interpolation grid resolution

datatoplot <- abs(EEGmeanscalp[f,condlist[f],])
datatoplot[which(is.na(datatoplot))] <- 0
datatoplot[which(datatoplot<0)] <- 0
datatoplot[which(datatoplot>30)] <- 0

testDat<- data.frame(x = xpos,
                     y = -ypos,
                     z = datatoplot)

#Create the interpolation grid
xo <- seq(min(-rmax, testDat$x), max(rmax, testDat$x), length = gridRes)
yo <- seq(max(rmax, testDat$y), min(-rmax, testDat$y), length = gridRes)

interpV4 <- v4Interp(testDat, xo, yo, rmax, gridRes)

zo2 <- as.matrix(interpV4[,2:ncol(interpV4)])

xo2 <- matrix(rep(xo,length(yo)),nrow = length(xo),ncol = length(yo))
yo2 <- t(matrix(rep(yo,length(xo)),nrow = length(yo),ncol = length(xo)))
outsidecircle <- sqrt(xo2^2 + yo2^2) > 0.51
zo2[outsidecircle] <- 0

ramp2 <- colorRamp(c("white",colpal[2]))  
colmatrix2 <- rgb(ramp2(seq(0, 1, length = 101)), max = 255)


tiff(paste0('headplot',f,'.tif'), height = 600, width = 600, units="px", bg="white")
    
plotlims <- c(-rmax,rmax,-rmax,rmax)  
par(pty="s")  # make axis square
plot(x=NULL,y=NULL,ann=FALSE, axes=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4]) 
image(xo,xo,zo2,col=colmatrix2,zlim=c(0,0.7),add=TRUE,useRaster=FALSE)
maskx <- c(hdata$OutlineX[1:51]*2.2,hdata$OutlineX[51:1])
masky <- c(hdata$OutlineY[1:51]*2.2,hdata$OutlineY[51:1])
polygon(maskx,masky,border=NA,col="white")
maskx <- c(hdata$OutlineX[51:101]*2.2,hdata$OutlineX[101:51])
masky <- c(hdata$OutlineY[51:101]*2.2,hdata$OutlineY[101:51])
polygon(maskx,masky,border=NA,col="white")

blackelectrodes <- match('OZ',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)
blackelectrodes <- match('POZ',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)
blackelectrodes <- match('O1',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)
blackelectrodes <- match('O2',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)

lines(hdata$OutlineX,hdata$OutlineY,col="black",lwd=2)
lines(hdata$NoseX,hdata$NoseY,col="black",lwd=2)
lines(hdata$LearX,hdata$LearY,col="black",lwd=2)
lines(hdata$RearX,hdata$RearY,col="black",lwd=2)

dev.off()
}


  e1 <- readTIFF('headplot1.tif')
  e2 <- readTIFF('headplot2.tif')

  PostScriptTrace(paste('CRFs.ps',sep=''))
  e3 <- readPicture('CRFs.ps.xml')
  PostScriptTrace(paste('suppression.ps',sep=''))
  e4 <- readPicture('suppression.ps.xml')
  for (n in 1:length(e4@paths)){
    temp <- class(e4@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e4@paths[n]$path@rgb))<765){e4@paths[n]$path@rgb <- addalpha(e4@paths[n]$path@rgb,alpha=0.2)}}}
  
  PostScriptTrace(paste('spectrum.ps',sep=''))
  e5 <- readPicture('spectrum.ps.xml')
  for (n in 1:length(e5@paths)){
    temp <- class(e5@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e5@paths[n]$path@rgb))<765){e5@paths[n]$path@rgb <- addalpha(e5@paths[n]$path@rgb,alpha=0.2)}}}

   PostScriptTrace(paste('timecourse1.ps',sep=''))
  e6 <- readPicture('timecourse1.ps.xml')
  for (n in 1:length(e6@paths)){
    temp <- class(e6@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e6@paths[n]$path@rgb))<765){e6@paths[n]$path@rgb <- addalpha(e6@paths[n]$path@rgb,alpha=0.2)}}}
 
   PostScriptTrace(paste('timecourse2.ps',sep=''))
  e7 <- readPicture('timecourse2.ps.xml')
  for (n in 1:length(e7@paths)){
    temp <- class(e7@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e7@paths[n]$path@rgb))<765){e7@paths[n]$path@rgb <- addalpha(e7@paths[n]$path@rgb,alpha=0.2)}}}

     PostScriptTrace(paste('timecourse3.ps',sep=''))
  e8 <- readPicture('timecourse3.ps.xml')
  for (n in 1:length(e8@paths)){
    temp <- class(e8@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e8@paths[n]$path@rgb))<765){e8@paths[n]$path@rgb <- addalpha(e8@paths[n]$path@rgb,alpha=0.2)}}}

     PostScriptTrace(paste('timecourse4.ps',sep=''))
  e9 <- readPicture('timecourse4.ps.xml')
  for (n in 1:length(e9@paths)){
    temp <- class(e9@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e9@paths[n]$path@rgb))<765){e9@paths[n]$path@rgb <- addalpha(e9@paths[n]$path@rgb,alpha=0.2)}}}
  
  
  
  pdf('temp/figures/Fig2.pdf', bg="transparent", height = 6, width = 16)
  par(mar=c(0.1,0.1,0.1,0.1))
  plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=c(0,1), ylim=c(0,1)) 

  aspratio <- 6/16  # this is the aspect ratio of the output pdf
  imwidth <- 0.25
  xstart <- 0.02
  ystart <- 0.58
  rasterImage(e1,xstart,ystart,xstart+imwidth*aspratio,ystart+imwidth)
  xstart <- 0.22
  ystart <- 0.58
  rasterImage(e2,xstart,ystart,xstart+imwidth*aspratio,ystart+imwidth)

  grid.picture(e3,x=0.225,y=0.7,width=0.4,height=1)
  grid.picture(e5,x=0.225,y=0.25,width=0.4,height=1)

  grid.picture(e6,x=0.5,y=0.85,width=0.1,height=1)
  grid.picture(e7,x=0.5,y=0.625,width=0.1,height=1)
  grid.picture(e8,x=0.5,y=0.375,width=0.1,height=1)
  grid.picture(e9,x=0.5,y=0.15,width=0.1,height=1)
  grid.picture(e4,x=0.77,y=0.5,width=0.45,height=1)
  
  text(-0.02,0.98,'(a)',pos=4,cex=2)
  text(-0.02,0.45,'(b)',pos=4,cex=2)
  text(0.41,0.98,'(c)',pos=4,cex=2)
  text(0.57,0.98,'(d)',pos=4,cex=2)
  

  dev.off()
  
  file.remove(c('headplot1.tif','headplot2.tif','spectrum.ps','timecourse1.ps','timecourse2.ps','timecourse3.ps','timecourse4.ps','suppression.ps','CRFs.ps'))
  file.remove(c('spectrum.ps.xml','timecourse1.ps.xml','timecourse2.ps.xml','timecourse3.ps.xml','timecourse4.ps.xml','suppression.ps.xml','CRFs.ps.xml'))


}



```

```{r Pilotdata, fig.cap="Summary of pilot analysis of data from Vilidiate et al. (2018). Panel (a) shows contrast response functions at the target frequency (7Hz, left) and the mask frequency (5Hz, right). Insets show the distribution of activity across the scalp, with points marking electrodes Oz, POz, O1 and O2. Panel (b) shows Fourier spectra for the single component stimuli and their combination (plaid). Note the strong second harmonic components at 14Hz and 10Hz. Panel (c) shows timecourses of frequency-locked responses to a single stimulus (black) and the plaid stimulus (blue), compared to baseline (grey). Panel (d) shows the timecourse of suppression at each frequency (7Hz, 5Hz, 14Hz, 10Hz) and their average (black curve). Error bars in panel (a) and shaded regions in panels (c,d) indicate ±1SE, and grey rectangles indicate the timing of stimulus presentation. The larger symbols in panel (a) indicate conditions used for subsequent analyses.", fig.align="center", echo=FALSE}

knitr::include_graphics('temp/figures/Fig2.pdf')

```

Our initial reanalysis was promising, however the data were noisy despite the large sample size, because each participant contributed only 8 trials (88 seconds) to each condition. We therefore preregistered two new experiments (see https://osf.io/4qudc) to investigate these effects in greater detail. These had a similar overall design to the Vilidaite study, with some small changes intended to optimise the study (see Methods). The key differences were that we used shorter trials (because there were few changes in the latter part of the trials shown in Figure \@ref(fig:Pilotdata)), and also focussed all trials into a smaller number of conditions, such that each participant contributed 48 repetitions (288 seconds of data) to each of 4 conditions.

Figure \@ref(fig:EEGdata) summarises the results of our EEG experiment testing a further 100 neurotypical adults. Averaged EEG waveforms showed a strong oscillatory component at each of the two stimulus flicker frequencies (Figure \@ref(fig:EEGdata)a), which slightly lagged the driving signal. Signals were well-isolated in the Fourier domain (Figure \@ref(fig:EEGdata)b), and localised to occipital electrodes. The timecourse at both frequencies showed an initial onset transient, and was then relatively stable for the 6 seconds of stimulus presentation (Figure \@ref(fig:EEGdata)c,d). Responses were weaker in the two masking conditions, and the ratio of target only to target + mask conditions increased over time (Figure \@ref(fig:EEGdata)e,f) for both mask types. At 5Hz the increase in masking continued over the first 5 seconds of stimulus presentation (Figure \@ref(fig:EEGdata)e), whereas at 7Hz the increase occurred mostly during the first second after onset (Figure \@ref(fig:EEGdata)f), consistent with the pilot data (see Figure \@ref(fig:Pilotdata)).

```{r include=FALSE, results='hide'}

samplerate <- 1000
targetF <- 5
maskF <- 7
duration <- 6
    binwidth <- 1000
    tindex <- 1 + targetF*(binwidth/samplerate)
    mindex <- 1 + maskF*(binwidth/samplerate)
    legaltriggers <- c(210,211,220,221,230,231,240,241)

 if (processdata>2){
   
osfproject <- osf_retrieve_node("ab3yv")
componentlist <- osf_ls_nodes(osfproject)
EEGID <- pmatch('Raw EEG data 1',as.character(unlist(componentlist[,1])))
EEGID[2] <- pmatch('Raw EEG data 2',as.character(unlist(componentlist[,1])))

subjcounter <- 0
for (datahalf in 1:length(EEGID)){
  EEGtoken <- componentlist[EEGID[datahalf],2]
  EEGfiles <- osf_ls_files(EEGtoken,n_max=300)
  for (f in 1:nrow(EEGfiles)){
    subjcounter <- subjcounter + 1
    print(subjcounter)
    # first check if we have this participant's data
    if (!file.exists(paste0('temp/EEGprocessed/S',subjcounter,'data.RData'))){
      # if we haven't processed the data, check if we need to download the raw data
      if (!dir.exists(paste0('temp/raw/S',subjcounter))){
        if (!file.exists(paste0('temp/raw/S',subjcounter,'.zip'))){
          osf_download(EEGfiles[f,], path='temp/raw/',progress=TRUE)
        }
          unzip(paste0('temp/raw/S',subjcounter,'.zip'),exdir='temp/raw/')
          file.remove(paste0('temp/raw/S',subjcounter,'.zip'))
      }
    # if necessary, process the data for this participant
      
      d <- dir(paste0('temp/raw/S',subjcounter), pattern='*.csv.gz',full.names=TRUE)
      condcounter <- (1:4) * 0
      alltrials <- array(0,dim=c(50,4,9000,64))
      subjwaves <- array(0,dim=c(4,9000,64))
      trialsincluded <- matrix(0,nrow=4,ncol=64)
      
      for (block in 1:length(d)){
      EEGdata <- read.csv(d[block], header = TRUE)
      electrodes <- colnames(EEGdata)

    triggertimes <- NULL
    counter <- 0
    for (n in 1:nrow(EEGdata)) {
      if (EEGdata$Trigger[n] %in% legaltriggers) {
        counter <- counter + 1
        triggertimes[counter] <- n
      }
    }
    
    # remove the first trial if there is not sufficient pre-trial baseline time
    if (triggertimes[1]<1500){triggertimes <- triggertimes[2:counter]}
    
     for (tr in 1:length(triggertimes)) {
      cond <- which(legaltriggers == EEGdata$Trigger[triggertimes[tr]])
      cond <- ceiling(cond/2)
      condcounter[cond] <- condcounter[cond] + 1

      # # horrible hack to fix one trial for P227
      # if (33-samplerate+(triggertimes[tr])<0){
      #   if (pno == 227){triggertimes[tr] <- triggertimes[tr] + 150}
      #   if (pno == 279){triggertimes[tr] <- triggertimes[tr] + 150}
      #  }
    for (ch in 1:64){     
      alltrials[condcounter[cond],cond,,ch] <- as.matrix(EEGdata[33-(1.5*samplerate)+(triggertimes[tr]:(triggertimes[tr] + samplerate * (3+duration) - 1)), ch+3])}
        
     }
        
      }
      
      for (cond in 1:4){
        for (ch in 1:64){
          
          temp <- alltrials[1:condcounter[cond],cond,,ch]
          
          spec5 <- NULL
          spec7 <- NULL
          for (t in 1:condcounter[cond]){
            spec <- fft(temp[t,1501:7500])
            spec5[t] <- spec[targetF*duration+1]
            spec7[t] <- spec[maskF*duration+1]
          }
        spec5[which(is.na(spec5))] <- 0
        spec7[which(is.na(spec7))] <- 0
      if (length(which(abs(spec5)>0))>2){  
      tempxy <- data.frame(Re(spec5),Im(spec5))
      D5 <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      tempxy <- data.frame(Re(spec7),Im(spec7))
      D7 <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))      
      i <- which(D5<3 & D7<3)
      trialsincluded[cond,ch] <- length(i)
      subjwaves[cond,,ch] <- colMeans(temp[i,])
      }   
        }
      }
      
      
      qdatasubj <- read.csv(paste0('temp/raw/S',subjcounter,'/questionnairedata.csv'))
      save(file=paste0('temp/EEGprocessed/S',subjcounter,'data.RData'),list=c('qdatasubj','condcounter','trialsincluded','subjwaves','electrodes'))
    }

    
    
 }
}
   
 }
if (processdata>1){    
d <- dir(path = 'temp/EEGprocessed', pattern = '*.RData', full.names=TRUE)
EEGtimecourse5Hz <- array(0,dim=c(length(d),4,8000))
EEGtimecourse7Hz <- array(0,dim=c(length(d),4,8000))
allwaves <- array(0,dim=c(length(d),4,9000))
allspec <- array(0,dim=c(length(d),4,duration*20))
allheads5 <- array(0,dim=c(length(d),4,64))
allheads7 <- array(0,dim=c(length(d),4,64))
allAQ <- NULL
for (s in 1:length(d)){
  load(d[s])
  targetchannels <- match(targetelectrodes, electrodes) - 2
  for (cond in 1:4){
    temp <- rowMeans(subjwaves[cond,,targetchannels],na.rm=TRUE)
    nainds <- which(is.na(temp))   # find occasional NaN values in the waveform
    # temp[nainds] <- (temp[nainds-1] + temp[nainds+1])/2   # interpolate adjacent values
    temp[nainds] <- 0   # replace with zeros
    allwaves[s,cond,] <- temp - mean(temp)
    spec <- fft(temp[1501:7500])/6000
    allspec[s,cond,] <- spec[1+(1:(duration*20))]

fspec1 <- NULL
fspec2 <- NULL
for (t in 1:(9000-binwidth)){
  spec <- fft(temp[t:(t+binwidth-1)])/binwidth
  fspec1[t] <- spec[tindex]
  fspec2[t] <- spec[mindex]
}
    EEGtimecourse5Hz[s,cond,] <- fspec1
    EEGtimecourse7Hz[s,cond,] <- fspec2


  for (ch in 1:64){
    temp <- fft(subjwaves[cond,1501:7500,ch])/6000
    allheads5[s,cond,ch] <- temp[1+(duration*targetF)]
    allheads7[s,cond,ch] <- temp[1+(duration*maskF)]
  }
  } 

allAQ[s] <- scoreAQ(qdatasubj[1,5:54]) 
  
}

save(file='temp/EEGsummary.RData',list=c('allheads5','allheads7','allspec','allwaves','EEGtimecourse5Hz','EEGtimecourse7Hz','electrodes','allAQ'))
 }
    
if (processdata>0){
load('temp/EEGsummary.RData')

isincluded <- matrix(rep(1,4*dim(allspec)[1]),nrow=4,ncol=dim(allspec)[1])
for (cond in 1:4){
  # note that in allspec the DC component has been removed
  # so we don't need to add 1 to the index
      tempxy <- data.frame(Re(allspec[,cond,duration*targetF]),Im(allspec[,cond,duration*targetF]))
      D5 <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      tempxy <- data.frame(Re(allspec[,cond,duration*maskF]),Im(allspec[,cond,duration*maskF]))      
      D7 <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))      
      isincluded[cond,which(D5>3)] <- 0
      isincluded[cond,which(D7>3)] <- 0
   for (s in 1:100){
     if (max(abs(EEGtimecourse5Hz[s,cond,]))>5){isincluded[cond,s] <- 0}
   }   
}

allwaves[which(allwaves<(-100))] <- 0
allwaves[which(allwaves>100)] <- 0

EEGmeantime5Hz <- matrix(0,nrow=4,ncol=8000)
EEGmeantime7Hz <- matrix(0,nrow=4,ncol=8000)
EEGSEtime5Hz <- matrix(0,nrow=4,ncol=8000)
EEGSEtime7Hz <- matrix(0,nrow=4,ncol=8000)
meanspec <- matrix(0,nrow=4,ncol=120)
meanwave <- matrix(0,nrow=4,ncol=9000)
meanhead5 <- matrix(0,nrow=4,ncol=64)
meanhead7 <- matrix(0,nrow=4,ncol=64)
for (cond in 1:4){
EEGmeantime7Hz[cond,] <- apply(abs(EEGtimecourse7Hz[which(isincluded[cond,]==1),cond,]),2,mean,na.rm=TRUE)
EEGmeantime5Hz[cond,] <- apply(abs(EEGtimecourse5Hz[which(isincluded[cond,]==1),cond,]),2,mean,na.rm=TRUE)

EEGSEtime7Hz[cond,] <- apply(abs(EEGtimecourse7Hz[which(isincluded[cond,]==1),cond,]),2,sd,na.rm=TRUE)/sqrt(sum(isincluded[cond,]))
EEGSEtime5Hz[cond,] <- apply(abs(EEGtimecourse5Hz[which(isincluded[cond,]==1),cond,]),2,sd,na.rm=TRUE)/sqrt(sum(isincluded[cond,]))

meanspec[cond,] <- colMeans(abs(allspec[which(isincluded[cond,]==1),cond,]),na.rm=TRUE)
meanwave[cond,] <- colMeans(allwaves[which(isincluded[cond,]==1),cond,],na.rm=TRUE)
meanhead5[cond,] <- abs(colMeans(abs(allheads5[which(isincluded[cond,]==1),cond,]),na.rm=TRUE))
meanhead7[cond,] <- abs(colMeans(abs(allheads7[which(isincluded[cond,]==1),cond,]),na.rm=TRUE))
}

EEGmaskindex5 <- matrix(0,nrow=2,ncol=8000)
EEGmaskindexSE5 <- matrix(0,nrow=2,ncol=8000)
includedboth <- isincluded[1,]*isincluded[3,]
monratios <- abs(EEGtimecourse5Hz[which(includedboth==1),1,])/abs(EEGtimecourse5Hz[which(includedboth==1),3,])
EEGmaskindex5[1,] <- colMeans(20*log10(monratios))
EEGmaskindexSE5[1,] <- apply(20*log10(monratios),2,sd)/sqrt(sum(includedboth))
includedboth <- isincluded[1,]*isincluded[4,]
dichratios <- abs(EEGtimecourse5Hz[which(includedboth==1),1,])/abs(EEGtimecourse5Hz[which(includedboth==1),4,])
EEGmaskindex5[2,] <- colMeans(20*log10(dichratios))
EEGmaskindexSE5[2,] <- apply(20*log10(dichratios),2,sd)/sqrt(sum(includedboth))

EEGmaskindex7 <- matrix(0,nrow=2,ncol=8000)
EEGmaskindexSE7 <- matrix(0,nrow=2,ncol=8000)
includedboth <- isincluded[2,]*isincluded[3,]
monratios <- abs(EEGtimecourse7Hz[which(includedboth==1),2,])/abs(EEGtimecourse7Hz[which(includedboth==1),3,])
EEGmaskindex7[1,] <- colMeans(20*log10(monratios))
EEGmaskindexSE7[1,] <- apply(20*log10(monratios),2,sd)/sqrt(sum(includedboth))
includedboth <- isincluded[2,]*isincluded[4,]
dichratios <- abs(EEGtimecourse7Hz[which(includedboth==1),2,])/abs(EEGtimecourse7Hz[which(includedboth==1),4,])
EEGmaskindex7[2,] <- colMeans(20*log10(dichratios))
EEGmaskindexSE7[2,] <- apply(20*log10(dichratios),2,sd)/sqrt(sum(includedboth))


# pdf("temp/figures/Fig3.pdf", bg="transparent", height = 10, width = 12)
# 
# par(mfrow=c(3,4))


times <- ((1:8000)-1000)/1000

postscript("timecourse1.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,0,0.6)
ticklocsx <- -1:7    # locations of tick marks on x axis
ticklocsy <- seq(0,0.6,0.1)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = ticklocsy, side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-0.022,-0.022,0.02,0.02),border=NA,col=rgb(0.5,0.5,0.5))

if (plotsmoothed==0){
polygon(times[c(1:8000,8000:1)],c(EEGmeantime5Hz[1,]+EEGSEtime5Hz[1,],EEGmeantime5Hz[1,8000:1]-EEGSEtime5Hz[1,8000:1]),col=colpal[1],border=NA)
polygon(times[c(1:8000,8000:1)],c(EEGmeantime5Hz[3,]+EEGSEtime5Hz[3,],EEGmeantime5Hz[3,8000:1]-EEGSEtime5Hz[3,8000:1]),col=colpal[2],border=NA)
polygon(times[c(1:8000,8000:1)],c(EEGmeantime5Hz[4,]+EEGSEtime5Hz[4,],EEGmeantime5Hz[4,8000:1]-EEGSEtime5Hz[4,8000:1]),col=colpal[3],border=NA)

lines(times,EEGmeantime5Hz[1,],lwd=2,col=colpal[1])
# lines(times,EEGmeantime5Hz[2,],lwd=2,col='green')
lines(times,EEGmeantime5Hz[3,],lwd=2,col=colpal[2])
lines(times,EEGmeantime5Hz[4,],lwd=2,col=colpal[3])
}

if (plotsmoothed==1){
spl5aU <- smooth.spline(times,EEGmeantime5Hz[1,]+EEGSEtime5Hz[1,],df=20)
spl5aL <- smooth.spline(times,EEGmeantime5Hz[1,]-EEGSEtime5Hz[1,],df=20)
polygon(times[c(1:8000,8000:1)],c(spl5aU$y,spl5aL$y[8000:1]),col=colpal[1],border=NA)

spl5cU <- smooth.spline(times,EEGmeantime5Hz[3,]+EEGSEtime5Hz[3,],df=20)
spl5cL <- smooth.spline(times,EEGmeantime5Hz[3,]-EEGSEtime5Hz[3,],df=20)
polygon(times[c(1:8000,8000:1)],c(spl5cU$y,spl5cL$y[8000:1]),col=colpal[2],border=NA)

spl5dU <- smooth.spline(times,EEGmeantime5Hz[4,]+EEGSEtime5Hz[4,],df=20)
spl5dL <- smooth.spline(times,EEGmeantime5Hz[4,]-EEGSEtime5Hz[4,],df=20)
polygon(times[c(1:8000,8000:1)],c(spl5dU$y,spl5dL$y[8000:1]),col=colpal[3],border=NA)

spl5a <- smooth.spline(times,EEGmeantime5Hz[1,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[1],lwd=2)
# spl5b <- smooth.spline(times,EEGmeantime5Hz[2,],df=20)
# lines(spl5b$x,spl5b$y,col='green',lwd=2)
spl5c <- smooth.spline(times,EEGmeantime5Hz[3,],df=20)
lines(spl5c$x,spl5c$y,col=colpal[2],lwd=2)
spl5d <- smooth.spline(times,EEGmeantime5Hz[4,],df=20)
lines(spl5d$x,spl5d$y,col=colpal[3],lwd=2)

}

dev.off()


postscript("timecourse2.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,-3,7)
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,7),c(0,0),lty=2)

if (plotsmoothed==0){
polygon(times[c(1:8000,8000:1)],c(EEGmaskindex5[1,]+EEGmaskindexSE5[1,],EEGmaskindex5[1,8000:1]-EEGmaskindexSE5[1,8000:1]),col=colpal[2],border=NA)
polygon(times[c(1:8000,8000:1)],c(EEGmaskindex5[2,]+EEGmaskindexSE5[2,],EEGmaskindex5[2,8000:1]-EEGmaskindexSE5[2,8000:1]),col=colpal[3],border=NA)

lines(times,EEGmaskindex5[1,],col=colpal[2],lwd=2)
lines(times,EEGmaskindex5[2,],col=colpal[3],lwd=2)
}
if (plotsmoothed==1){
U <- smooth.spline(times,EEGmaskindex5[1,]+EEGmaskindexSE5[1,],df=20)
L <- smooth.spline(times,EEGmaskindex5[1,]-EEGmaskindexSE5[1,],df=20)
polygon(times[c(1:8000,8000:1)],c(U$y,L$y[8000:1]),col=colpal[2],border=NA)

U <- smooth.spline(times,EEGmaskindex5[2,]+EEGmaskindexSE5[2,],df=20)
L <- smooth.spline(times,EEGmaskindex5[2,]-EEGmaskindexSE5[2,],df=20)
polygon(times[c(1:8000,8000:1)],c(U$y,L$y[8000:1]),col=colpal[3],border=NA)

L <- smooth.spline(times,EEGmaskindex5[1,],df=20)
lines(L$x,L$y,col=colpal[2],lwd=2)
L <- smooth.spline(times,EEGmaskindex5[2,],df=20)
lines(L$x,L$y,col=colpal[3],lwd=2)
}

dev.off()


postscript("timecourse3.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,0,0.6)
ticklocsy <- seq(0,0.6,0.1)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = ticklocsy, side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-0.022,-0.022,0.02,0.02),border=NA,col=rgb(0.5,0.5,0.5))

if (plotsmoothed==0){
polygon(times[c(1:8000,8000:1)],c(EEGmeantime7Hz[2,]+EEGSEtime7Hz[2,],EEGmeantime7Hz[2,8000:1]-EEGSEtime7Hz[2,8000:1]),col=colpal[1],border=NA)
polygon(times[c(1:8000,8000:1)],c(EEGmeantime7Hz[3,]+EEGSEtime7Hz[3,],EEGmeantime7Hz[3,8000:1]-EEGSEtime7Hz[3,8000:1]),col=colpal[2],border=NA)
polygon(times[c(1:8000,8000:1)],c(EEGmeantime7Hz[4,]+EEGSEtime7Hz[4,],EEGmeantime7Hz[4,8000:1]-EEGSEtime7Hz[4,8000:1]),col=colpal[3],border=NA)
  
# lines(times,EEGmeantime7Hz[1,],lwd=2,col=colpal[1])
lines(times,EEGmeantime7Hz[2,],lwd=2,col=colpal[1])
lines(times,EEGmeantime7Hz[3,],lwd=2,col=colpal[2])
lines(times,EEGmeantime7Hz[4,],lwd=2,col=colpal[3])
}
if (plotsmoothed==1){
  
spl7bU <- smooth.spline(times,EEGmeantime7Hz[2,]+EEGSEtime7Hz[2,],df=20)
spl7bL <- smooth.spline(times,EEGmeantime7Hz[2,]-EEGSEtime7Hz[2,],df=20)
polygon(times[c(1:8000,8000:1)],c(spl7bU$y,spl7bL$y[8000:1]),col=colpal[1],border=NA)

spl7cU <- smooth.spline(times,EEGmeantime7Hz[3,]+EEGSEtime7Hz[3,],df=20)
spl7cL <- smooth.spline(times,EEGmeantime7Hz[3,]-EEGSEtime7Hz[3,],df=20)
polygon(times[c(1:8000,8000:1)],c(spl7cU$y,spl7cL$y[8000:1]),col=colpal[2],border=NA)

spl7dU <- smooth.spline(times,EEGmeantime7Hz[4,]+EEGSEtime7Hz[4,],df=20)
spl7dL <- smooth.spline(times,EEGmeantime7Hz[4,]-EEGSEtime7Hz[4,],df=20)
polygon(times[c(1:8000,8000:1)],c(spl7dU$y,spl7dL$y[8000:1]),col=colpal[3],border=NA)

# spl7a <- smooth.spline(times,EEGmeantime7Hz[1,],df=20)
# lines(spl7a$x,spl7a$y,col=colpal[1],lwd=2)
spl7b <- smooth.spline(times,EEGmeantime7Hz[2,],df=20)
lines(spl7b$x,spl7b$y,col=colpal[1],lwd=2)
spl7c <- smooth.spline(times,EEGmeantime7Hz[3,],df=20)
lines(spl7c$x,spl7c$y,col=colpal[2],lwd=2)
spl7d <- smooth.spline(times,EEGmeantime7Hz[4,],df=20)
lines(spl7d$x,spl7d$y,col=colpal[3],lwd=2)
}

dev.off()

postscript("timecourse4.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,-3,6)
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,7),c(0,0),lty=2)

if (plotsmoothed==0){
polygon(times[c(1:8000,8000:1)],c(EEGmaskindex7[1,]+EEGmaskindexSE7[1,],EEGmaskindex7[1,8000:1]-EEGmaskindexSE7[1,8000:1]),col=colpal[2],border=NA)
polygon(times[c(1:8000,8000:1)],c(EEGmaskindex7[2,]+EEGmaskindexSE7[2,],EEGmaskindex7[2,8000:1]-EEGmaskindexSE7[2,8000:1]),col=colpal[3],border=NA)

lines(times,EEGmaskindex7[1,],col=colpal[2],lwd=2)
lines(times,EEGmaskindex7[2,],col=colpal[3],lwd=2)
}

if (plotsmoothed==1){
U <- smooth.spline(times,EEGmaskindex7[1,]+EEGmaskindexSE7[1,],df=20)
L <- smooth.spline(times,EEGmaskindex7[1,]-EEGmaskindexSE7[1,],df=20)
polygon(times[c(1:8000,8000:1)],c(U$y,L$y[8000:1]),col=colpal[2],border=NA)

U <- smooth.spline(times,EEGmaskindex7[2,]+EEGmaskindexSE7[2,],df=20)
L <- smooth.spline(times,EEGmaskindex7[2,]-EEGmaskindexSE7[2,],df=20)
polygon(times[c(1:8000,8000:1)],c(U$y,L$y[8000:1]),col=colpal[3],border=NA)

L <- smooth.spline(times,EEGmaskindex7[1,],df=20)
lines(L$x,L$y,col=colpal[2],lwd=2)
L <- smooth.spline(times,EEGmaskindex7[2,],df=20)
lines(L$x,L$y,col=colpal[3],lwd=2)
}

dev.off()


freqlist <- seq(1/6,20,length=ncol(meanspec))

postscript("spectrum.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 10)

plotlims <- c(0,20,0,4)  # define the x and y limits of the plot (minx,maxx,miny,maxy)
ticklocsx <- seq(0,20,5)    # locations of tick marks on x axis
ticklocsy <- c(0,0.4,0.8,1,2,3,4)    # locations of tick marks on y axis
ticklabelsx <- seq(0,20,5)        # set labels for x ticks
ticklabelsy <- c(0,0.2,0.4,'','','','')    # set labels for y ticks
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])   
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)     # plot tick marks (no labels)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklabelsx, side = 1, at=ticklocsx)     # add the tick labels
mtext(text = ticklabelsy, side = 2, at=ticklocsy, line=0.2, las=1) 
title(xlab="Frequency (Hz)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    # titles for axes
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

lines(c(0,20),c(0,0),lty=3)
lines(c(0,20),c(1,1),lty=3)
lines(c(0,20),c(2,2),lty=3)
lines(c(0,20),c(3,3),lty=3)

# lines(c(5,5),c(0,4),col='grey',lwd=2)
# lines(c(7,7),c(0,4),col='grey',lwd=2)

polygon(c(1,freqlist[6:120],20),c(0,2*meanspec[1,6:120],0)+3,border=NA,col=colpal[1])
polygon(c(1,freqlist[6:120],20),c(0,2*meanspec[2,6:120],0)+2,border=NA,col=colpal[1])
polygon(c(1,freqlist[6:120],20),c(0,2*meanspec[3,6:120],0)+1,border=NA,col=colpal[2])
polygon(c(1,freqlist[6:120],20),c(0,2*meanspec[4,6:120],0),border=NA,col=colpal[3])

lines(freqlist[6:120],2*meanspec[1,6:120]+3,lwd=2,col='black')
lines(freqlist[6:120],2*meanspec[2,6:120]+2,lwd=2,col='black')
lines(freqlist[6:120],2*meanspec[3,6:120]+1,lwd=2,col='black')
lines(freqlist[6:120],2*meanspec[4,6:120],lwd=2,col='black')

text(20,3.5,'5Hz monocular target',pos=2,cex=1.5)
text(20,2.5,'7Hz monocular target',pos=2,cex=1.5)
text(20,1.5,'Monocular combination',pos=2,cex=1.5)
text(20,0.5,'Dichoptic combination',pos=2,cex=1.5)

dev.off()


times <- seq(1/1000,9,1/1000)-1.5
trigwaveform1 <- -cos(2 * 5 * times * pi)
trigwaveform2 <- -cos(2 * 7 * times * pi)
trigwaveform1[1:1500] <- -1
trigwaveform1[7501:9000] <- -1
trigwaveform2[1:1500] <- -1
trigwaveform2[7501:9000] <- -1

postscript("waveform1.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 12)

plotlims <- c(-1,7,-3,2)  # define the x and y limits of the plot (minx,maxx,miny,maxy)
ticklocsx <- seq(-1,7,1)    # locations of tick marks on x axis
ticklocsy <- seq(-3,2,1)    # locations of tick marks on y axis
ticklabelsx <- seq(-1,7,1)        # set labels for x ticks
ticklabelsy <- ticklocsy    # set labels for y ticks
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])   
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)     # plot tick marks (no labels)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklabelsx, side = 1, at=ticklocsx)     # add the tick labels
mtext(text = ticklabelsy, side = 2, at=ticklocsy, line=0.2, las=1)  
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    # titles for axes
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)
polygon(c(0,6,6,0,0),c(-3,-3,2,2,-2),col=rgb(0.95,0.95,0.95),border=NA)

lines(times[501:8500],meanwave[1,501:8500],lwd=1,col=colpal[2])
lines(times[501:8500],(trigwaveform1[501:8500]/2) - 2.5)
# text(-1,1.8,'5Hz average waveform',pos=4,cex=1.5)

dev.off()

postscript("waveform2.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 12)

plotlims <- c(-1,7,-3,2)  # define the x and y limits of the plot (minx,maxx,miny,maxy)
ticklocsx <- seq(-1,7,1)    # locations of tick marks on x axis
ticklocsy <- seq(-3,2,1)    # locations of tick marks on y axis
ticklabelsx <- seq(-1,7,1)        # set labels for x ticks
ticklabelsy <- ticklocsy    # set labels for y ticks
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])   
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)     # plot tick marks (no labels)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklabelsx, side = 1, at=ticklocsx)     # add the tick labels
mtext(text = ticklabelsy, side = 2, at=ticklocsy, line=0.2, las=1)  
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    # titles for axes
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)
polygon(c(0,6,6,0,0),c(-3,-3,2,2,-2),col=rgb(0.95,0.95,0.95),border=NA)

lines(times[501:8500],meanwave[2,501:8500],lwd=1,col=colpal[2])
lines(times[501:8500],(trigwaveform2[501:8500]/2) - 2.5)
# text(-1,1.8,'7Hz average waveform',pos=4,cex=1.5)

dev.off()

xpos <- 1:64
ypos <- 1:64
montageE <- toupper(as.character(hdata$Electrode))
for (ch in 1:64){
  i <- match(toupper(electrodes[ch+2]),montageE)
  xpos[ch] <- hdata$X_position[i]
  ypos[ch] <- hdata$Y_position[i]
}


rmax <- 0.55   #specify a maximum boundary for the grid
gridRes <- 100 #specify the interpolation grid resolution

datatoplot <- meanhead5[1,]
datatoplot[which(is.na(datatoplot))] <- 0
datatoplot[which(datatoplot<0)] <- 0
datatoplot[which(datatoplot>30)] <- 0

testDat<- data.frame(x = xpos,
                     y = -ypos,
                     z = datatoplot)

#Create the interpolation grid
xo <- seq(min(-rmax, testDat$x), max(rmax, testDat$x), length = gridRes)
yo <- seq(max(rmax, testDat$y), min(-rmax, testDat$y), length = gridRes)

interpV4 <- v4Interp(testDat, xo, yo, rmax, gridRes)

zo2 <- as.matrix(interpV4[,2:ncol(interpV4)])

xo2 <- matrix(rep(xo,length(yo)),nrow = length(xo),ncol = length(yo))
yo2 <- t(matrix(rep(yo,length(xo)),nrow = length(yo),ncol = length(xo)))
outsidecircle <- sqrt(xo2^2 + yo2^2) > 0.51
zo2[outsidecircle] <- 0

ramp2 <- colorRamp(c("white",colpal[2]))  
colmatrix2 <- rgb(ramp2(seq(0, 1, length = 101)), max = 255)


tiff('headplot1.tif', height = 600, width = 600, units="px", bg="white")
    
plotlims <- c(-rmax,rmax,-rmax,rmax)  
par(pty="s")  # make axis square
plot(x=NULL,y=NULL,ann=FALSE, axes=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4]) 
image(xo,xo,zo2,col=colmatrix2,zlim=c(0,1),add=TRUE,useRaster=FALSE)
maskx <- c(hdata$OutlineX[1:51]*2.2,hdata$OutlineX[51:1])
masky <- c(hdata$OutlineY[1:51]*2.2,hdata$OutlineY[51:1])
polygon(maskx,masky,border=NA,col="white")
maskx <- c(hdata$OutlineX[51:101]*2.2,hdata$OutlineX[101:51])
masky <- c(hdata$OutlineY[51:101]*2.2,hdata$OutlineY[101:51])
polygon(maskx,masky,border=NA,col="white")

blackelectrodes <- match('OZ',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)
blackelectrodes <- match('POZ',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)
blackelectrodes <- match('O1',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)
blackelectrodes <- match('O2',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)

lines(hdata$OutlineX,hdata$OutlineY,col="black",lwd=2)
lines(hdata$NoseX,hdata$NoseY,col="black",lwd=2)
lines(hdata$LearX,hdata$LearY,col="black",lwd=2)
lines(hdata$RearX,hdata$RearY,col="black",lwd=2)

# text(0,-0.55,'5Hz response',cex=1.5,adj=0.5)

dev.off()

datatoplot <- meanhead7[2,]
datatoplot[which(is.na(datatoplot))] <- 0
datatoplot[which(datatoplot<0)] <- 0
datatoplot[which(datatoplot>30)] <- 0

testDat<- data.frame(x = xpos,
                     y = -ypos,
                     z = datatoplot)

#Create the interpolation grid
xo <- seq(min(-rmax, testDat$x), max(rmax, testDat$x), length = gridRes)
yo <- seq(max(rmax, testDat$y), min(-rmax, testDat$y), length = gridRes)

interpV4 <- v4Interp(testDat, xo, yo, rmax, gridRes)

zo2 <- as.matrix(interpV4[,2:ncol(interpV4)])

xo2 <- matrix(rep(xo,length(yo)),nrow = length(xo),ncol = length(yo))
yo2 <- t(matrix(rep(yo,length(xo)),nrow = length(yo),ncol = length(xo)))
outsidecircle <- sqrt(xo2^2 + yo2^2) > 0.51
zo2[outsidecircle] <- 0

tiff('headplot2.tif', height = 600, width = 600, units="px", bg="white")

par(pty="s")  # make axis square
plot(x=NULL,y=NULL,ann=FALSE, axes=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4]) 
image(xo,xo,zo2,col=colmatrix2,zlim=c(0,1),add=TRUE,useRaster=FALSE)
maskx <- c(hdata$OutlineX[1:51]*2.2,hdata$OutlineX[51:1])
masky <- c(hdata$OutlineY[1:51]*2.2,hdata$OutlineY[51:1])
polygon(maskx,masky,border=NA,col="white")
maskx <- c(hdata$OutlineX[51:101]*2.2,hdata$OutlineX[101:51])
masky <- c(hdata$OutlineY[51:101]*2.2,hdata$OutlineY[101:51])
polygon(maskx,masky,border=NA,col="white")

blackelectrodes <- match('OZ',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)
blackelectrodes <- match('POZ',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)
blackelectrodes <- match('O1',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)
blackelectrodes <- match('O2',toupper(as.character(electrodes[3:66])))
points(xpos[blackelectrodes],ypos[blackelectrodes],pch=16,col="black",cex=1.6)

lines(hdata$OutlineX,hdata$OutlineY,col="black",lwd=2)
lines(hdata$NoseX,hdata$NoseY,col="black",lwd=2)
lines(hdata$LearX,hdata$LearY,col="black",lwd=2)
lines(hdata$RearX,hdata$RearY,col="black",lwd=2)

# text(0,-0.55,'7Hz response',cex=1.5,adj=0.5)

dev.off()

# baseline <- data.frame(Re(allspec[,1,duration*targetF]),Im(allspec[,1,duration*targetF]))
# monmask <- data.frame(Re(allspec[,3,duration*targetF]),Im(allspec[,3,duration*targetF]))
# dichmask <- data.frame(Re(allspec[,4,duration*targetF]),Im(allspec[,4,duration*targetF]))
# 
# par(pty="s")  # make axis square
# plotlims <- c(-1,1,-1,1)
# plot(x=NULL,y=NULL,ann=FALSE, axes=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4]) 
# lines(plotlims[1:2],c(0,0))
# lines(c(0,0),plotlims[1:2])
# 
# points(baseline[,1],baseline[,2],pch=16,cex=0.5,col=addalpha(colpal[1],0.2))
# points(monmask[,1],monmask[,2],pch=16,cex=0.5,col=addalpha(colpal[2],0.2))
# points(dichmask[,1],dichmask[,2],pch=16,cex=0.5,col=addalpha(colpal[3],0.2))
# 
# points(mean(baseline[,1]),mean(baseline[,2]),pch=16,cex=2,col=addalpha(colpal[1],1))
# points(mean(monmask[,1]),mean(monmask[,2]),pch=16,cex=2,col=addalpha(colpal[2],1))
# points(mean(dichmask[,1]),mean(dichmask[,2]),pch=16,cex=2,col=addalpha(colpal[3],1))
# 
# 
# 
# baseline <- data.frame(Re(allspec[,2,duration*maskF]),Im(allspec[,2,duration*maskF]))
# monmask <- data.frame(Re(allspec[,3,duration*maskF]),Im(allspec[,3,duration*maskF]))
# dichmask <- data.frame(Re(allspec[,4,duration*maskF]),Im(allspec[,4,duration*maskF]))
# 
# par(pty="s")  # make axis square
# plotlims <- c(-1,1,-1,1)
# plot(x=NULL,y=NULL,ann=FALSE, axes=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4]) 
# lines(plotlims[1:2],c(0,0))
# lines(c(0,0),plotlims[1:2])
# 
# points(baseline[,1],baseline[,2],pch=16,cex=0.5,col=addalpha(colpal[1],0.2))
# points(monmask[,1],monmask[,2],pch=16,cex=0.5,col=addalpha(colpal[2],0.2))
# points(dichmask[,1],dichmask[,2],pch=16,cex=0.5,col=addalpha(colpal[3],0.2))
# 
# points(mean(baseline[,1]),mean(baseline[,2]),pch=16,cex=2,col=addalpha(colpal[1],1))
# points(mean(monmask[,1]),mean(monmask[,2]),pch=16,cex=2,col=addalpha(colpal[2],1))
# points(mean(dichmask[,1]),mean(dichmask[,2]),pch=16,cex=2,col=addalpha(colpal[3],1))
# 


  e1 <- readTIFF('headplot1.tif')
  e2 <- readTIFF('headplot2.tif')

  PostScriptTrace(paste('waveform1.ps',sep=''))
  e3 <- readPicture('waveform1.ps.xml')
  PostScriptTrace(paste('waveform2.ps',sep=''))
  e4 <- readPicture('waveform2.ps.xml')
  
  PostScriptTrace(paste('spectrum.ps',sep=''))
  e5 <- readPicture('spectrum.ps.xml')
  for (n in 1:length(e5@paths)){
    temp <- class(e5@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e5@paths[n]$path@rgb))<765){e5@paths[n]$path@rgb <- addalpha(e5@paths[n]$path@rgb,alpha=0.2)}}}

   PostScriptTrace(paste('timecourse1.ps',sep=''))
  e6 <- readPicture('timecourse1.ps.xml')
  for (n in 1:length(e6@paths)){
    temp <- class(e6@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e6@paths[n]$path@rgb))<765){e6@paths[n]$path@rgb <- addalpha(e6@paths[n]$path@rgb,alpha=0.2)}}}
 
   PostScriptTrace(paste('timecourse2.ps',sep=''))
  e7 <- readPicture('timecourse2.ps.xml')
  for (n in 1:length(e7@paths)){
    temp <- class(e7@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e7@paths[n]$path@rgb))<765){e7@paths[n]$path@rgb <- addalpha(e7@paths[n]$path@rgb,alpha=0.2)}}}

     PostScriptTrace(paste('timecourse3.ps',sep=''))
  e8 <- readPicture('timecourse3.ps.xml')
  for (n in 1:length(e8@paths)){
    temp <- class(e8@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e8@paths[n]$path@rgb))<765){e8@paths[n]$path@rgb <- addalpha(e8@paths[n]$path@rgb,alpha=0.2)}}}

     PostScriptTrace(paste('timecourse4.ps',sep=''))
  e9 <- readPicture('timecourse4.ps.xml')
  for (n in 1:length(e9@paths)){
    temp <- class(e9@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e9@paths[n]$path@rgb))<765){e9@paths[n]$path@rgb <- addalpha(e9@paths[n]$path@rgb,alpha=0.2)}}}
  
  
  
  pdf('temp/figures/Fig3.pdf', bg="transparent", height = 6, width = 15)
  par(mar=c(0.1,0.1,0.1,0.1))
  plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=c(0,1), ylim=c(0,1)) 

  aspratio <- 6/15  # this is the aspect ratio of the output pdf
  imwidth <- 0.28
  xstart <- 0.02
  ystart <- 0.75
  rasterImage(e1,xstart,ystart,xstart+imwidth*aspratio,ystart+imwidth)
  ystart <- 0.475
  rasterImage(e2,xstart,ystart,xstart+imwidth*aspratio,ystart+imwidth)

  grid.picture(e3,x=0.3,y=0.85,width=0.3,height=1)
  grid.picture(e4,x=0.3,y=0.6,width=0.3,height=1)
  grid.picture(e5,x=0.25,y=0.25,width=0.45,height=1)

  grid.picture(e6,x=0.6,y=0.75,width=0.25,height=1)
  grid.picture(e7,x=0.85,y=0.75,width=0.25,height=1)
  grid.picture(e8,x=0.6,y=0.25,width=0.25,height=1)
  grid.picture(e9,x=0.85,y=0.25,width=0.25,height=1)
  
  text(-0.02,1,'(a)',pos=4,cex=2)
  text(-0.02,0.45,'(b)',pos=4,cex=2)
  text(0.515,1,'(c)',pos=4,cex=2)
  text(0.515,0.46,'(d)',pos=4,cex=2)
  text(0.785,1,'(e)',pos=4,cex=2)
  text(0.785,0.46,'(f)',pos=4,cex=2)
  
  text(-0.02,0.89,'5Hz',pos=4,cex=2)
  text(-0.02,0.61,'7Hz',pos=4,cex=2)

  dev.off()
  
  file.remove(c('headplot1.tif','headplot2.tif','spectrum.ps','timecourse1.ps','timecourse2.ps','timecourse3.ps','timecourse4.ps','waveform1.ps','waveform2.ps'))
  file.remove(c('spectrum.ps.xml','timecourse1.ps.xml','timecourse2.ps.xml','timecourse3.ps.xml','timecourse4.ps.xml','waveform1.ps.xml','waveform2.ps.xml'))

}
    
```

```{r EEGdata, fig.cap="Summary of EEG results for N=100 neurotypical participants. Panel (a) shows scalp topographies and averaged waveforms for 5Hz (top) and 7Hz (bottom) stimuli. The black sine wave trace in each panel illustrates the driving contrast modulation, and black points on the scalp topographies indicate electrodes Oz, O1, O2 and POz. Panel (b) shows the Fourier amplitude spectrum for each condition, with clear peaks at 5Hz and 7Hz. Panels (c,d) show timecourses at each frequency for the baseline condition (black), and the monocular (blue) and dichoptic (red) masking conditions. Panels (e,f) show suppression ratios as a function of time for each mask type. Light grey rectangles indicate the period of stimulus presentation.", fig.align="center", echo=FALSE}

knitr::include_graphics('temp/figures/Fig3.pdf')

```

Next we repeated the experiment on 20 participants using a 248-channel whole-head cryogenic MEG system. Half of the participants had a diagnosis of autism, and the remainder were age and gender-matched controls. Source localisation using a linearly constrained minimum variance (LCMV) beamformer algorithm (reference) showed strong localisation of steady-state signals at the occipital pole (see Figure \@ref(fig:MEGdata)a,b). 

Responses across V1 showed a similar timecourse to those of the EEG experiment at both frequencies (Figure 4c,d), and showed increasing suppression during the first 4 seconds of stimulus presentation (Figure 4e,f).


```{r include=FALSE, results='hide'}

nareas <- 7
samplerate <- 1001
targetF <- 5
maskF <- 7
duration <- 6
    binwidth <- 1001
    tindex <- 1 + targetF*(binwidth/samplerate)
    mindex <- 1 + maskF*(binwidth/samplerate)
MEGareacols <- cols25(8)[c(1:5,8,7)]
  
if (processdata>1){
  
d <- dir(path = 'temp/MEGtrialsWang/', pattern = '*alltrials.mat', full.names=TRUE)
d2 <- dir(path = 'temp/MEGtrialsWang/', pattern = '*alltrials.mat', full.names=FALSE)

MEGtimecourse5Hz <- array(0,dim=c(length(d),nareas,4,8008))
MEGtimecourse7Hz <- array(0,dim=c(length(d),nareas,4,8008))
# allwaves <- array(0,dim=c(length(d),4,9009))
allspec <- array(0,dim=c(length(d),nareas,4,duration*20))
allRnos <- NULL
for (s in 1:length(d)){
  allRnos[s] <- substr(d2[s],1,5)
  data <- readMat(d[s])
  for (area in 1:nareas){
  for (cond in 1:4){
    temp <- colMeans(data$alltrials[area,cond,1:data$trialcounter[1,cond],],na.rm=TRUE)
    nainds <- which(is.na(temp))   # find occasional NaN values in the waveform
    temp[nainds] <- 0   # replace with zeros
    # allwaves[s,cond,] <- temp - mean(temp)
    spec <- fft(temp[1501:7500])/6000
    allspec[s,area,cond,] <- spec[1+(1:(duration*20))]

fspec1 <- NULL
fspec2 <- NULL
for (t in 1:(9009-binwidth)){
  spec <- fft(temp[t:(t+binwidth-1)])/binwidth
  fspec1[t] <- spec[tindex]
  fspec2[t] <- spec[mindex]
}
    MEGtimecourse5Hz[s,area,cond,] <- fspec1
    MEGtimecourse7Hz[s,area,cond,] <- fspec2

  } 
  
}
}

save(file='temp/MEGsummary.RData',list=c('allspec','MEGtimecourse5Hz','MEGtimecourse7Hz','allRnos'))
}

if (processdata>0){
load('temp/MEGsummary.RData')

isincluded <- array(1, dim=c(nareas,4,dim(allspec)[1]))
for (area in 1:nareas){
for (cond in 1:4){
  # note that in allspec the DC component has been removed
  # so we don't need to add 1 to the index
      tempxy <- data.frame(Re(allspec[,area,cond,duration*targetF]),Im(allspec[,area,cond,duration*targetF]))
      D5 <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      tempxy <- data.frame(Re(allspec[,area,cond,duration*maskF]),Im(allspec[,area,cond,duration*maskF]))      
      D7 <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))      
      isincluded[area,cond,which(D5>3)] <- 0
      isincluded[area,cond,which(D7>3)] <- 0
   for (s in 1:20){
     if (max(abs(MEGtimecourse5Hz[s,area,cond,]))>5){isincluded[area,cond,s] <- 0}
   }   
}
}

MEGmeantime5Hz <- array(0,dim=c(nareas,4,8008))
MEGmeantime7Hz <- array(0,dim=c(nareas,4,8008))
MEGSEtime5Hz <- array(0,dim=c(nareas,4,8008))
MEGSEtime7Hz <- array(0,dim=c(nareas,4,8008))
meanspec <- array(0,dim=c(nareas,4,120))
for (area in 1:nareas){
for (cond in 1:4){
MEGmeantime7Hz[area,cond,] <- apply(abs(MEGtimecourse7Hz[which(isincluded[area,cond,]==1),area,cond,]),2,mean,na.rm=TRUE)
MEGmeantime5Hz[area,cond,] <- apply(abs(MEGtimecourse5Hz[which(isincluded[area,cond,]==1),area,cond,]),2,mean,na.rm=TRUE)

MEGSEtime7Hz[area,cond,] <- apply(abs(MEGtimecourse7Hz[which(isincluded[area,cond,]==1),area,cond,]),2,sd,na.rm=TRUE)/sqrt(sum(isincluded[area,cond,]))
MEGSEtime5Hz[area,cond,] <- apply(abs(MEGtimecourse5Hz[which(isincluded[area,cond,]==1),area,cond,]),2,sd,na.rm=TRUE)/sqrt(sum(isincluded[area,cond,]))

meanspec[area,cond,] <- abs(colMeans(allspec[which(isincluded[area,cond,]==1),area,cond,],na.rm=TRUE))
# meanwave[area,cond,] <- colMeans(allwaves[which(isincluded[area,cond,]==1),area,cond,],na.rm=TRUE)
}
}

MEGmaskindex5 <- array(0, dim=c(nareas,2,8008))
MEGmaskindexSE5 <- array(0, dim=c(nareas,2,8008))
MEGmaskindex7 <- array(0, dim=c(nareas,2,8008))
MEGmaskindexSE7 <- array(0, dim=c(nareas,2,8008))
for (area in 1:nareas){
includedboth <- isincluded[area,1,]*isincluded[area,3,]
monratios <- abs(MEGtimecourse5Hz[which(includedboth==1),area,1,])/abs(MEGtimecourse5Hz[which(includedboth==1),area,3,])
MEGmaskindex5[area,1,] <- colMeans(20*log10(monratios))
MEGmaskindexSE5[area,1,] <- apply(20*log10(monratios),2,sd)/sqrt(sum(includedboth))
includedboth <- isincluded[area,1,]*isincluded[area,4,]
dichratios <- abs(MEGtimecourse5Hz[which(includedboth==1),area,1,])/abs(MEGtimecourse5Hz[which(includedboth==1),area,4,])
MEGmaskindex5[area,2,] <- colMeans(20*log10(dichratios))
MEGmaskindexSE5[area,2,] <- apply(20*log10(dichratios),2,sd)/sqrt(sum(includedboth))

includedboth <- isincluded[area,2,]*isincluded[area,3,]
monratios <- abs(MEGtimecourse7Hz[which(includedboth==1),area,2,])/abs(MEGtimecourse7Hz[which(includedboth==1),area,3,])
MEGmaskindex7[area,1,] <- colMeans(20*log10(monratios))
MEGmaskindexSE7[area,1,] <- apply(20*log10(monratios),2,sd)/sqrt(sum(includedboth))
includedboth <- isincluded[area,2,]*isincluded[area,4,]
dichratios <- abs(MEGtimecourse7Hz[which(includedboth==1),area,2,])/abs(MEGtimecourse7Hz[which(includedboth==1),area,4,])
MEGmaskindex7[area,2,] <- colMeans(20*log10(dichratios))
MEGmaskindexSE7[area,2,] <- apply(20*log10(dichratios),2,sd)/sqrt(sum(includedboth))
}

times <- ((1:8008)-1001)/1001

postscript("timecourse1.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,0,0.6)
ticklocsx <- -1:7    # locations of tick marks on x axis
ticklocsy <- seq(0,0.6,0.1)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = ticklocsy, side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Amplitude", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-0.022,-0.022,0.02,0.02),border=NA,col=rgb(0.5,0.5,0.5))

if (plotsmoothed==0){
polygon(times[c(1:8008,8008:1)],10*c(MEGmeantime5Hz[1,]+MEGSEtime5Hz[1,],MEGmeantime5Hz[1,8008:1]-MEGSEtime5Hz[1,8008:1]),col=colpal[1],border=NA)
polygon(times[c(1:8008,8008:1)],10*c(MEGmeantime5Hz[3,]+MEGSEtime5Hz[3,],MEGmeantime5Hz[3,8008:1]-MEGSEtime5Hz[3,8008:1]),col=colpal[2],border=NA)
polygon(times[c(1:8008,8008:1)],10*c(MEGmeantime5Hz[4,]+MEGSEtime5Hz[4,],MEGmeantime5Hz[4,8008:1]-MEGSEtime5Hz[4,8008:1]),col=colpal[3],border=NA)

lines(times,10*MEGmeantime5Hz[1,],lwd=2,col=colpal[1])
# lines(times,MEGmeantime5Hz[2,],lwd=2,col='green')
lines(times,10*MEGmeantime5Hz[3,],lwd=2,col=colpal[2])
lines(times,10*MEGmeantime5Hz[4,],lwd=2,col=colpal[3])
}

if (plotsmoothed==1){
  for (area in 1:nareas){
spl5aU <- smooth.spline(times,MEGmeantime5Hz[area,1,]+MEGSEtime5Hz[area,1,],df=20)
spl5aL <- smooth.spline(times,MEGmeantime5Hz[area,1,]-MEGSEtime5Hz[area,1,],df=20)
polygon(times[c(1:8008,8008:1)],c(spl5aU$y,spl5aL$y[8008:1]),col=colpal[1],border=NA)

spl5cU <- smooth.spline(times,MEGmeantime5Hz[area,3,]+MEGSEtime5Hz[area,3,],df=20)
spl5cL <- smooth.spline(times,MEGmeantime5Hz[area,3,]-MEGSEtime5Hz[area,3,],df=20)
polygon(times[c(1:8008,8008:1)],c(spl5cU$y,spl5cL$y[8008:1]),col=colpal[2],border=NA)

spl5dU <- smooth.spline(times,MEGmeantime5Hz[area,4,]+MEGSEtime5Hz[area,4,],df=20)
spl5dL <- smooth.spline(times,MEGmeantime5Hz[area,4,]-MEGSEtime5Hz[area,4,],df=20)
polygon(times[c(1:8008,8008:1)],c(spl5dU$y,spl5dL$y[8008:1]),col=colpal[3],border=NA)
  }
  for (area in 1:nareas){  
spl5a <- smooth.spline(times,10*MEGmeantime5Hz[area,1,],df=20)
lines(spl5a$x,spl5a$y,col=colpal[1],lwd=2)
# spl5b <- smooth.spline(times,MEGmeantime5Hz[2,],df=20)
# lines(spl5b$x,spl5b$y,col='green',lwd=2)
spl5c <- smooth.spline(times,10*MEGmeantime5Hz[area,3,],df=20)
lines(spl5c$x,spl5c$y,col=colpal[2],lwd=2)
spl5d <- smooth.spline(times,10*MEGmeantime5Hz[area,4,],df=20)
lines(spl5d$x,spl5d$y,col=colpal[3],lwd=2)
}
}

dev.off()

postscript("timecourse2.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,-3,7)
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,7),c(0,0),lty=2)

if (plotsmoothed==0){
polygon(times[c(1:8008,8008:1)],c(MEGmaskindex5[1,]+MEGmaskindexSE5[1,],MEGmaskindex5[1,8008:1]-MEGmaskindexSE5[1,8008:1]),col=colpal[2],border=NA)
polygon(times[c(1:8008,8008:1)],c(MEGmaskindex5[2,]+MEGmaskindexSE5[2,],MEGmaskindex5[2,8008:1]-MEGmaskindexSE5[2,8008:1]),col=colpal[3],border=NA)


lines(times,MEGmaskindex5[1,],col=colpal[2],lwd=2)
lines(times,MEGmaskindex5[2,],col=colpal[3],lwd=2)
}
if (plotsmoothed==1){
U <- smooth.spline(times,MEGmaskindex5[1,]+MEGmaskindexSE5[1,],df=20)
L <- smooth.spline(times,MEGmaskindex5[1,]-MEGmaskindexSE5[1,],df=20)
polygon(times[c(1:8008,8008:1)],c(U$y,L$y[8008:1]),col=colpal[2],border=NA)

U <- smooth.spline(times,MEGmaskindex5[2,]+MEGmaskindexSE5[2,],df=20)
L <- smooth.spline(times,MEGmaskindex5[2,]-MEGmaskindexSE5[2,],df=20)
polygon(times[c(1:8008,8008:1)],c(U$y,L$y[8008:1]),col=colpal[3],border=NA)

for (area in 1:nareas){ 
L <- smooth.spline(times,MEGmaskindex5[area,1,],df=20)
lines(L$x,L$y,col=MEGareacols[area],lwd=2)
# L <- smooth.spline(times,MEGmaskindex5[area,2,],df=20)
# lines(L$x,L$y,col=colpal[3],lwd=2)
}
legend(1,2,c('V1','V2','V3','hV4','TO','LO','VO'),col=MEGareacols,lwd=2)
}

dev.off()


postscript("timecourse2.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,-3,7)
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,7),c(0,0),lty=2)

for (area in 1:nareas){ 
L <- smooth.spline(times,MEGmaskindex5[area,2,],df=20)
lines(L$x,L$y,col=MEGareacols[area],lwd=2)
# L <- smooth.spline(times,MEGmaskindex5[area,2,],df=20)
# lines(L$x,L$y,col=colpal[3],lwd=2)
}
legend(1,2,c('V1','V2','V3','hV4','TO','LO','VO'),col=MEGareacols,lwd=2)


dev.off()


postscript("timecourse2.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,-3,7)
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,7),c(0,0),lty=2)

if (plotsmoothed==0){
polygon(times[c(1:8008,8008:1)],c(MEGmaskindex5[1,]+MEGmaskindexSE5[1,],MEGmaskindex5[1,8008:1]-MEGmaskindexSE5[1,8008:1]),col=colpal[2],border=NA)
polygon(times[c(1:8008,8008:1)],c(MEGmaskindex5[2,]+MEGmaskindexSE5[2,],MEGmaskindex5[2,8008:1]-MEGmaskindexSE5[2,8008:1]),col=colpal[3],border=NA)


lines(times,MEGmaskindex5[1,],col=colpal[2],lwd=2)
lines(times,MEGmaskindex5[2,],col=colpal[3],lwd=2)
}
if (plotsmoothed==1){
U <- smooth.spline(times,MEGmaskindex5[1,]+MEGmaskindexSE5[1,],df=20)
L <- smooth.spline(times,MEGmaskindex5[1,]-MEGmaskindexSE5[1,],df=20)
polygon(times[c(1:8008,8008:1)],c(U$y,L$y[8008:1]),col=colpal[2],border=NA)

U <- smooth.spline(times,MEGmaskindex5[2,]+MEGmaskindexSE5[2,],df=20)
L <- smooth.spline(times,MEGmaskindex5[2,]-MEGmaskindexSE5[2,],df=20)
polygon(times[c(1:8008,8008:1)],c(U$y,L$y[8008:1]),col=colpal[3],border=NA)

for (area in 1:nareas){ 
L <- smooth.spline(times,MEGmaskindex7[area,1,],df=20)
lines(L$x,L$y,col=MEGareacols[area],lwd=2)
# L <- smooth.spline(times,MEGmaskindex5[area,2,],df=20)
# lines(L$x,L$y,col=colpal[3],lwd=2)
}
legend(1,2,c('V1','V2','V3','hV4','TO','LO','VO'),col=MEGareacols,lwd=2)
}

dev.off()


postscript("timecourse2.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,-3,7)
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,7),c(0,0),lty=2)

for (area in 1:nareas){ 
L <- smooth.spline(times,MEGmaskindex7[area,2,],df=20)
lines(L$x,L$y,col=MEGareacols[area],lwd=2)
# L <- smooth.spline(times,MEGmaskindex5[area,2,],df=20)
# lines(L$x,L$y,col=colpal[3],lwd=2)
}
legend(1,2,c('V1','V2','V3','hV4','TO','LO','VO'),col=MEGareacols,lwd=2)


dev.off()

postscript("timecourse3.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,0,0.6)
ticklocsy <- seq(0,0.6,0.1)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = ticklocsy, side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-0.022,-0.022,0.02,0.02),border=NA,col=rgb(0.5,0.5,0.5))

if (plotsmoothed==0){
polygon(times[c(1:8008,8008:1)],10*c(MEGmeantime7Hz[2,]+MEGSEtime7Hz[2,],MEGmeantime7Hz[2,8008:1]-MEGSEtime7Hz[2,8008:1]),col=colpal[1],border=NA)
polygon(times[c(1:8008,8008:1)],10*c(MEGmeantime7Hz[3,]+MEGSEtime7Hz[3,],MEGmeantime7Hz[3,8008:1]-MEGSEtime7Hz[3,8008:1]),col=colpal[2],border=NA)
polygon(times[c(1:8008,8008:1)],10*c(MEGmeantime7Hz[4,]+MEGSEtime7Hz[4,],MEGmeantime7Hz[4,8008:1]-MEGSEtime7Hz[4,8008:1]),col=colpal[3],border=NA)
  
# lines(times,MEGmeantime7Hz[1,],lwd=2,col=colpal[1])
lines(times,10*MEGmeantime7Hz[2,],lwd=2,col=colpal[1])
lines(times,10*MEGmeantime7Hz[3,],lwd=2,col=colpal[2])
lines(times,10*MEGmeantime7Hz[4,],lwd=2,col=colpal[3])
}
if (plotsmoothed==1){
  
spl7bU <- smooth.spline(times,MEGmeantime7Hz[2,]+MEGSEtime7Hz[2,],df=20)
spl7bL <- smooth.spline(times,MEGmeantime7Hz[2,]-MEGSEtime7Hz[2,],df=20)
polygon(times[c(1:8008,8008:1)],c(spl7bU$y,spl7bL$y[8008:1]),col=colpal[1],border=NA)

spl7cU <- smooth.spline(times,MEGmeantime7Hz[3,]+MEGSEtime7Hz[3,],df=20)
spl7cL <- smooth.spline(times,MEGmeantime7Hz[3,]-MEGSEtime7Hz[3,],df=20)
polygon(times[c(1:8008,8008:1)],c(spl7cU$y,spl7cL$y[8008:1]),col=colpal[2],border=NA)

spl7dU <- smooth.spline(times,MEGmeantime7Hz[4,]+MEGSEtime7Hz[4,],df=20)
spl7dL <- smooth.spline(times,MEGmeantime7Hz[4,]-MEGSEtime7Hz[4,],df=20)
polygon(times[c(1:8008,8008:1)],c(spl7dU$y,spl7dL$y[8008:1]),col=colpal[3],border=NA)

# spl7a <- smooth.spline(times,MEGmeantime7Hz[1,],df=20)
# lines(spl7a$x,spl7a$y,col=colpal[1],lwd=2)
  for (area in 1:nareas){ 
spl7b <- smooth.spline(times,10*MEGmeantime7Hz[area,2,],df=20)
lines(spl7b$x,spl7b$y,col=colpal[1],lwd=2)
spl7c <- smooth.spline(times,10*MEGmeantime7Hz[area,3,],df=20)
lines(spl7c$x,spl7c$y,col=colpal[2],lwd=2)
spl7d <- smooth.spline(times,10*MEGmeantime7Hz[area,4,],df=20)
lines(spl7d$x,spl7d$y,col=colpal[3],lwd=2)
}
}

dev.off()

postscript("timecourse4.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,-3,6)
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,7),c(0,0),lty=2)

if (plotsmoothed==0){
polygon(times[c(1:8008,8008:1)],c(MEGmaskindex7[1,]+MEGmaskindexSE7[1,],MEGmaskindex7[1,8008:1]-MEGmaskindexSE7[1,8008:1]),col=colpal[2],border=NA)
polygon(times[c(1:8008,8008:1)],c(MEGmaskindex7[2,]+MEGmaskindexSE7[2,],MEGmaskindex7[2,8008:1]-MEGmaskindexSE7[2,8008:1]),col=colpal[3],border=NA)

lines(times,MEGmaskindex7[1,],col=colpal[2],lwd=2)
lines(times,MEGmaskindex7[2,],col=colpal[3],lwd=2)
}

if (plotsmoothed==1){
U <- smooth.spline(times,MEGmaskindex7[1,]+MEGmaskindexSE7[1,],df=20)
L <- smooth.spline(times,MEGmaskindex7[1,]-MEGmaskindexSE7[1,],df=20)
polygon(times[c(1:8008,8008:1)],c(U$y,L$y[8008:1]),col=colpal[2],border=NA)

U <- smooth.spline(times,MEGmaskindex7[2,]+MEGmaskindexSE7[2,],df=20)
L <- smooth.spline(times,MEGmaskindex7[2,]-MEGmaskindexSE7[2,],df=20)
polygon(times[c(1:8008,8008:1)],c(U$y,L$y[8008:1]),col=colpal[3],border=NA)

for (area in 1:nareas){
L <- smooth.spline(times,MEGmaskindex7[area,1,],df=20)
lines(L$x,L$y,col=colpal[2],lwd=2)
L <- smooth.spline(times,MEGmaskindex7[area,2,],df=20)
lines(L$x,L$y,col=colpal[3],lwd=2)
}
}

dev.off()


# freqlist <- seq(1/6,20,length=ncol(meanspec))
# 
# postscript("spectrum.ps", horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 10)
# 
# plotlims <- c(0,20,0,4)  # define the x and y limits of the plot (minx,maxx,miny,maxy)
# ticklocsx <- seq(0,20,5)    # locations of tick marks on x axis
# ticklocsy <- c(0,0.4,0.8,1,2,3,4)    # locations of tick marks on y axis
# ticklabelsx <- seq(0,20,5)        # set labels for x ticks
# ticklabelsy <- c(0,0.2,0.4,'','','','')    # set labels for y ticks
# plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])   
# axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)     # plot tick marks (no labels)
# axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
# mtext(text = ticklabelsx, side = 1, at=ticklocsx)     # add the tick labels
# mtext(text = ticklabelsy, side = 2, at=ticklocsy, line=0.2, las=1) 
# title(xlab="Frequency (Hz)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    # titles for axes
# title(ylab="Amplitude (µV)", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)
# 
# lines(c(0,20),c(0,0),lty=3)
# lines(c(0,20),c(1,1),lty=3)
# lines(c(0,20),c(2,2),lty=3)
# lines(c(0,20),c(3,3),lty=3)
# 
# # lines(c(5,5),c(0,4),col='grey',lwd=2)
# # lines(c(7,7),c(0,4),col='grey',lwd=2)
# 
# polygon(c(1/6,freqlist,20),c(0,100*meanspec[1,],0)+3,border=NA,col=colpal[1])
# polygon(c(1/6,freqlist,20),c(0,100*meanspec[2,],0)+2,border=NA,col=colpal[1])
# polygon(c(1/6,freqlist,20),c(0,100*meanspec[3,],0)+1,border=NA,col=colpal[2])
# polygon(c(1/6,freqlist,20),c(0,100*meanspec[4,],0),border=NA,col=colpal[3])
# 
# lines(freqlist,100*meanspec[1,]+3,lwd=2,col='black')
# lines(freqlist,100*meanspec[2,]+2,lwd=2,col='black')
# lines(freqlist,100*meanspec[3,]+1,lwd=2,col='black')
# lines(freqlist,100*meanspec[4,],lwd=2,col='black')
# 
# text(20,3.5,'5Hz monocular target',pos=2,cex=1.5)
# text(20,2.5,'7Hz monocular target',pos=2,cex=1.5)
# text(20,1.5,'Monocular combination',pos=2,cex=1.5)
# text(20,0.5,'Dichoptic combination',pos=2,cex=1.5)
# 
# dev.off()








# 
# 
# allresps <- array(0, dim=c(length(d),4,2,9))
# allspectra <- array(0, dim=c(length(d),4,6006))
# allwaves <- array(0, dim=c(length(d), 4, 9009))
# MEGtimecourse7Hz <- array(0, dim=c(length(d),4,8009))
# MEGtimecourse5Hz <- array(0, dim=c(length(d),4,8009))
# allRnos <- NULL
# for (s in 1:length(d)){
#   allRnos[s] <- substr(d2[s],1,5)
#   data <- readMat(d[s])
#   
#   for (cond in 1:4){
#       for (t in 1:9){
#         all1F <- NULL
#         all2F <- NULL
#         for (rep in 1:data$trialcounter[1,cond]){
#           trial <- data$alltrials[cond,rep,]
# 
#         sample <- trial[(1+((t-1)*1001)):(t*1001)]
#         fftsample <- fft(sample)/length(sample)
# 
#         all1F[rep] <- fftsample[targetF + 1]
#         all2F[rep] <- fftsample[maskF + 1]
#       }
# 
#         tempxy <- data.frame(Re(all1F),Im(all1F))
#         D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
#         i <- which(D<3)
#         allresps[s,cond,1,t] <- mean(all1F[i])
# 
#         tempxy <- data.frame(Re(all2F),Im(all2F))
#         D <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
#         i <- which(D<3)
#         allresps[s,cond,2,t] <- mean(all2F[i])
#     }
#     
#     meanwave <- colMeans(data$alltrials[cond,1:data$trialcounter[1,cond],])
#     
#     sample <- meanwave[1001:7006]
#     allspectra[s,cond,] <- fft(sample)/length(sample)  
# 
#     allwaves[s,cond,] <- meanwave
#     
# fspec1 <- NULL
# fspec2 <- NULL
# for (t in 1:(length(meanwave)-binwidth)){
#   spec <- fft(meanwave[t:(t+binwidth-1)])/binwidth
#   fspec1[t] <- spec[tindex]
#   fspec2[t] <- spec[mindex]
# }
#     MEGtimecourse5Hz[s,cond,] <- fspec1
#     MEGtimecourse7Hz[s,cond,] <- fspec2
#     
#     
#   }
# }
# 
# save(file='temp/MEGsummary.RData',list=c('allspectra','allresps','allwaves','MEGtimecourse5Hz','MEGtimecourse7Hz','allRnos'))
# }
#     
# if (runcode==1){
#   
#   load('temp/MEGsummary.RData')
#   
# allresps <- abs(allresps)
# meanspec <- apply(allresps,2:4,mean)
# 
# MEGmeantime5Hz <- matrix(0,nrow=4,ncol=8009) 
# MEGmeantime7Hz <- matrix(0,nrow=4,ncol=8009) 
# for (cond in 1:4){
# MEGmeantime7Hz[cond,] <- apply(abs(MEGtimecourse7Hz[,cond,]),2,mean)
# MEGmeantime5Hz[cond,] <- apply(abs(MEGtimecourse5Hz[,cond,]),2,mean)
# }
# 
# 
# qdata <- read.csv('~/Google Drive/Current work/Teaching/MSci project 2021/MSci project questionnaires 2021 (Responses) - Form Responses 1.csv')
# qgroup <- as.factor(qdata[,5])
# qRnos <- as.character(qdata[,2])
# qAges <- qdata[,3]
# qRnos[20] <- 'R5860'
# qgroup[20] <- 'Yes'
# qAges[20] <- 19
# 
#   
# sortedgroups <- NULL
# for (s in 1:length(allRnos)){sortedgroups[s] <- qgroup[which(qRnos==allRnos[s])]}
# # sortedgroups now codes 1 = control, 2 = ASC in the order of the MEG data
# 
# lowAQ <- abs(apply(abs(allresps[which(sortedgroups==1),,,]),c(2,3,4),mean))
# highAQ <- abs(apply(abs(allresps[which(sortedgroups==2),,,]),c(2,3,4),mean))
# 
# 
# 
# 
# MEGmeantime5HzCON <- matrix(0,nrow=4,ncol=8009) 
# MEGmeantime7HzCON <- matrix(0,nrow=4,ncol=8009) 
# MEGmeantime5HzASD <- matrix(0,nrow=4,ncol=8009) 
# MEGmeantime7HzASD <- matrix(0,nrow=4,ncol=8009) 
# for (cond in 1:4){
# MEGmeantime7HzCON[cond,] <- apply(abs(MEGtimecourse7Hz[which(sortedgroups==1),cond,]),2,mean)
# MEGmeantime5HzCON[cond,] <- apply(abs(MEGtimecourse5Hz[which(sortedgroups==1),cond,]),2,mean)
# MEGmeantime7HzASD[cond,] <- apply(abs(MEGtimecourse7Hz[which(sortedgroups==2),cond,]),2,mean)
# MEGmeantime5HzASD[cond,] <- apply(abs(MEGtimecourse5Hz[which(sortedgroups==2),cond,]),2,mean)
# }
# 
# pdf("temp/figures/Fig4.pdf", bg="transparent", height = 10, width = 10)
# 
# par(mfrow=c(2,2))
# 
# times <- ((1:8009)-500)/1000
# 
# plotlims <- c(-1,8,0,30)  # define the x and y limits of the plot (minx,maxx,miny,maxy)
# ticklocsx <- -1:8    # locations of tick marks on x axis
# ticklocsy <- seq(0,30,10)    # locations of tick marks on y axis
# ticklabelsx <- -1:8        # set labels for x ticks
# ticklabelsy <- ticklocsy    # set labels for y ticks
# plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])   
# axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2) 
# axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
# mtext(text = ticklabelsx, side = 1, at=ticklocsx) 
# mtext(text = ticklabelsy, side = 2, at=ticklocsy, line=0.2, las=1)  
# title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    # titles for axes
# title(ylab="Amplitude", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)
# 
# # lines(times,1000*meanspec[1,1,],lwd=2,col=colpal[1])
# # lines(times,1000*meanspec[2,1,],lwd=2,col='green')
# # lines(times,1000*meanspec[3,1,],lwd=2,col=colpal[2])
# # lines(times,1000*meanspec[4,1,],lwd=2,col=colpal[3])
# 
# 
# # lines(times,1000*MEGmeantime5Hz[1,],lwd=2,col=colpal[1])
# # lines(times,1000*MEGmeantime5Hz[2,],lwd=2,col='green')
# # lines(times,1000*MEGmeantime5Hz[3,],lwd=2,col=colpal[2])
# # lines(times,1000*MEGmeantime5Hz[4,],lwd=2,col=colpal[3])
# spl5a <- smooth.spline(times,1000*MEGmeantime5Hz[1,],df=20)
# lines(spl5a$x,spl5a$y,col=colpal[1],lwd=2)
# spl5b <- smooth.spline(times,1000*MEGmeantime5Hz[2,],df=20)
# lines(spl5b$x,spl5b$y,col='green',lwd=2)
# spl5c <- smooth.spline(times,1000*MEGmeantime5Hz[3,],df=20)
# lines(spl5c$x,spl5c$y,col=colpal[2],lwd=2)
# spl5d <- smooth.spline(times,1000*MEGmeantime5Hz[4,],df=20)
# lines(spl5d$x,spl5d$y,col=colpal[3],lwd=2)
# 
# # lines(times,1000*MEGmeantime5HzASD[1,],lwd=2,col=colpal[1],lty=2)
# # lines(times,1000*MEGmeantime5HzASD[2,],lwd=2,col='green',lty=2)
# # lines(times,1000*MEGmeantime5HzASD[3,],lwd=2,col=colpal[2],lty=2)
# # lines(times,1000*MEGmeantime5HzASD[4,],lwd=2,col=colpal[3],lty=2)
# spl5aASD <- smooth.spline(times,1000*MEGmeantime5HzASD[1,],df=20)
# lines(spl5aASD$x,spl5aASD$y,col=colpal[1],lwd=2,lty=2)
# spl5bASD <- smooth.spline(times,1000*MEGmeantime5HzASD[2,],df=20)
# lines(spl5bASD$x,spl5bASD$y,col='green',lwd=2,lty=2)
# spl5cASD <- smooth.spline(times,1000*MEGmeantime5HzASD[3,],df=20)
# lines(spl5cASD$x,spl5cASD$y,col=colpal[2],lwd=2,lty=2)
# spl5dASD <- smooth.spline(times,1000*MEGmeantime5HzASD[4,],df=20)
# lines(spl5dASD$x,spl5dASD$y,col=colpal[3],lwd=2,lty=2)
# 
# # lines(times,1000*MEGmeantime5HzCON[1,],lwd=2,col=colpal[1],lty=3)
# # lines(times,1000*MEGmeantime5HzCON[2,],lwd=2,col='green',lty=3)
# # lines(times,1000*MEGmeantime5HzCON[3,],lwd=2,col=colpal[2],lty=3)
# # lines(times,1000*MEGmeantime5HzCON[4,],lwd=2,col=colpal[3],lty=3)
# spl5aCON <- smooth.spline(times,1000*MEGmeantime5HzCON[1,],df=20)
# lines(spl5aCON$x,spl5aCON$y,col=colpal[1],lwd=2,lty=3)
# spl5bCON <- smooth.spline(times,1000*MEGmeantime5HzCON[2,],df=20)
# lines(spl5bCON$x,spl5bCON$y,col='green',lwd=2,lty=3)
# spl5cCON <- smooth.spline(times,1000*MEGmeantime5HzCON[3,],df=20)
# lines(spl5cCON$x,spl5cCON$y,col=colpal[2],lwd=2,lty=3)
# spl5dCON <- smooth.spline(times,1000*MEGmeantime5HzCON[4,],df=20)
# lines(spl5dCON$x,spl5dCON$y,col=colpal[3],lwd=2,lty=3)
# 
# 
# 
# plotlims <- c(-1,8,0,2)  # define the x and y limits of the plot (minx,maxx,miny,maxy)
# ticklocsx <- -1:8    # locations of tick marks on x axis
# ticklocsy <- seq(0,2,1)    # locations of tick marks on y axis
# ticklabelsx <- -1:8        # set labels for x ticks
# ticklabelsy <- ticklocsy    # set labels for y ticks
# plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])   
# axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2) 
# axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
# mtext(text = ticklabelsx, side = 1, at=ticklocsx) 
# mtext(text = ticklabelsy, side = 2, at=ticklocsy, line=0.2, las=1)  
# title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    # titles for axes
# title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)
# 
# lines(spl5b$x,spl5a$y/spl5c$y,col=colpal[2],lwd=2)
# lines(spl5b$x,spl5a$y/spl5d$y,col=colpal[3],lwd=2)
# 
# lines(spl5bASD$x,spl5aASD$y/spl5cASD$y,col=colpal[2],lwd=2,lty=2)
# lines(spl5bASD$x,spl5aASD$y/spl5dASD$y,col=colpal[3],lwd=2,lty=2)
# 
# lines(spl5bCON$x,spl5aCON$y/spl5cCON$y,col=colpal[2],lwd=2,lty=3)
# lines(spl5bCON$x,spl5aCON$y/spl5dCON$y,col=colpal[3],lwd=2,lty=3)
# 
# 
# plotlims <- c(-1,8,0,30)  # define the x and y limits of the plot (minx,maxx,miny,maxy)
# ticklocsx <- -1:8    # locations of tick marks on x axis
# ticklocsy <- seq(0,30,10)    # locations of tick marks on y axis
# ticklabelsx <- -1:8        # set labels for x ticks
# ticklabelsy <- ticklocsy    # set labels for y ticks
# plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])   
# axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2) 
# axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
# mtext(text = ticklabelsx, side = 1, at=ticklocsx) 
# mtext(text = ticklabelsy, side = 2, at=ticklocsy, line=0.2, las=1)  
# title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    # titles for axes
# title(ylab="Amplitude", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)
# 
# 
# # lines(times,1000*MEGmeantime7Hz[1,],lwd=2,col=colpal[1])
# # lines(times,1000*MEGmeantime7Hz[2,],lwd=2,col='green')
# # lines(times,1000*MEGmeantime7Hz[3,],lwd=2,col=colpal[2])
# # lines(times,1000*MEGmeantime7Hz[4,],lwd=2,col=colpal[3])
# spl7a <- smooth.spline(times,1000*MEGmeantime7Hz[1,],df=20)
# lines(spl7a$x,spl7a$y,col=colpal[1],lwd=2)
# spl7b <- smooth.spline(times,1000*MEGmeantime7Hz[2,],df=20)
# lines(spl7b$x,spl7b$y,col='green',lwd=2)
# spl7c <- smooth.spline(times,1000*MEGmeantime7Hz[3,],df=20)
# lines(spl7c$x,spl7c$y,col=colpal[2],lwd=2)
# spl7d <- smooth.spline(times,1000*MEGmeantime7Hz[4,],df=20)
# lines(spl7d$x,spl7d$y,col=colpal[3],lwd=2)
# 
# # lines(times,1000*MEGmeantime7HzASD[1,],lwd=2,col=colpal[1],lty=2)
# # lines(times,1000*MEGmeantime7HzASD[2,],lwd=2,col='green',lty=2)
# # lines(times,1000*MEGmeantime7HzASD[3,],lwd=2,col=colpal[2],lty=2)
# # lines(times,1000*MEGmeantime7HzASD[4,],lwd=2,col=colpal[3],lty=2)
# spl7aASD <- smooth.spline(times,1000*MEGmeantime7HzASD[1,],df=20)
# lines(spl7aASD$x,spl7aASD$y,col=colpal[1],lwd=2,lty=2)
# spl7bASD <- smooth.spline(times,1000*MEGmeantime7HzASD[2,],df=20)
# lines(spl7bASD$x,spl7bASD$y,col='green',lwd=2,lty=2)
# spl7cASD <- smooth.spline(times,1000*MEGmeantime7HzASD[3,],df=20)
# lines(spl7cASD$x,spl7cASD$y,col=colpal[2],lwd=2,lty=2)
# spl7dASD <- smooth.spline(times,1000*MEGmeantime7HzASD[4,],df=20)
# lines(spl7dASD$x,spl7dASD$y,col=colpal[3],lwd=2,lty=2)
# 
# # lines(times,1000*MEGmeantime7HzCON[1,],lwd=2,col=colpal[1],lty=3)
# # lines(times,1000*MEGmeantime7HzCON[2,],lwd=2,col='green',lty=3)
# # lines(times,1000*MEGmeantime7HzCON[3,],lwd=2,col=colpal[2],lty=3)
# # lines(times,1000*MEGmeantime7HzCON[4,],lwd=2,col=colpal[3],lty=3)
# spl7aCON <- smooth.spline(times,1000*MEGmeantime7HzCON[1,],df=20)
# lines(spl7aCON$x,spl7aCON$y,col=colpal[1],lwd=2,lty=3)
# spl7bCON <- smooth.spline(times,1000*MEGmeantime7HzCON[2,],df=20)
# lines(spl7bCON$x,spl7bCON$y,col='green',lwd=2,lty=3)
# spl7cCON <- smooth.spline(times,1000*MEGmeantime7HzCON[3,],df=20)
# lines(spl7cCON$x,spl7cCON$y,col=colpal[2],lwd=2,lty=3)
# spl7dCON <- smooth.spline(times,1000*MEGmeantime7HzCON[4,],df=20)
# lines(spl7dCON$x,spl7dCON$y,col=colpal[3],lwd=2,lty=3)
# 
# 
# plotlims <- c(-1,8,0,2)  # define the x and y limits of the plot (minx,maxx,miny,maxy)
# ticklocsx <- -1:8    # locations of tick marks on x axis
# ticklocsy <- seq(0,2,1)    # locations of tick marks on y axis
# ticklabelsx <- -1:8        # set labels for x ticks
# ticklabelsy <- ticklocsy    # set labels for y ticks
# plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])   
# axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2) 
# axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
# mtext(text = ticklabelsx, side = 1, at=ticklocsx) 
# mtext(text = ticklabelsy, side = 2, at=ticklocsy, line=0.2, las=1)  
# title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    # titles for axes
# title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)
# 
# lines(spl7b$x,spl7b$y/spl7c$y,col=colpal[2],lwd=2)
# lines(spl7b$x,spl7b$y/spl7d$y,col=colpal[3],lwd=2)
# 
# lines(spl7bASD$x,spl7bASD$y/spl7cASD$y,col=colpal[2],lwd=2,lty=2)
# lines(spl7bASD$x,spl7bASD$y/spl7dASD$y,col=colpal[3],lwd=2,lty=2)
# 
# lines(spl7bCON$x,spl7bCON$y/spl7cCON$y,col=colpal[2],lwd=2,lty=3)
# lines(spl7bCON$x,spl7bCON$y/spl7dCON$y,col=colpal[3],lwd=2,lty=3)
# 
# 
# # lines(times,1000*meanspec[1,2,],lwd=2,lty=2,col=colpal[1])
# # lines(times,1000*meanspec[2,2,],lwd=2,lty=2,col='green')
# # lines(times,1000*meanspec[3,2,],lwd=2,lty=2,col=colpal[2])
# # lines(times,1000*meanspec[4,2,],lwd=2,lty=2,col=colpal[3])
# 
# # text(-0.5,3.8,paste0('N=',length(allRnos)),cex=2)
# # condlist <- c('5Hz target only','5Hz mask only','5Hz mon','5Hz dich','7Hz target only','7Hz mask only','7Hz mon','7Hz dich')
# # if (outputplot>0){legend(0,4,condlist,col=c(colpal[1],'green',colpal[2],colpal[3]),lty=c(1,1,1,1,2,2,2,2),lwd=2,box.lwd=2)}
# 
# dev.off()

   PostScriptTrace(paste('timecourse1.ps',sep=''))
  e6 <- readPicture('timecourse1.ps.xml')
  for (n in 1:length(e6@paths)){
    temp <- class(e6@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e6@paths[n]$path@rgb))<765){e6@paths[n]$path@rgb <- addalpha(e6@paths[n]$path@rgb,alpha=0.2)}}}
 
   PostScriptTrace(paste('timecourse2.ps',sep=''))
  e7 <- readPicture('timecourse2.ps.xml')
  for (n in 1:length(e7@paths)){
    temp <- class(e7@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e7@paths[n]$path@rgb))<765){e7@paths[n]$path@rgb <- addalpha(e7@paths[n]$path@rgb,alpha=0.2)}}}

     PostScriptTrace(paste('timecourse3.ps',sep=''))
  e8 <- readPicture('timecourse3.ps.xml')
  for (n in 1:length(e8@paths)){
    temp <- class(e8@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e8@paths[n]$path@rgb))<765){e8@paths[n]$path@rgb <- addalpha(e8@paths[n]$path@rgb,alpha=0.2)}}}

     PostScriptTrace(paste('timecourse4.ps',sep=''))
  e9 <- readPicture('timecourse4.ps.xml')
  for (n in 1:length(e9@paths)){
    temp <- class(e9@paths[n]$path)[1]
    if (pmatch(temp,"PictureFill",nomatch=0)){
      if (sum(col2rgb(e9@paths[n]$path@rgb))<765){e9@paths[n]$path@rgb <- addalpha(e9@paths[n]$path@rgb,alpha=0.2)}}}
  
  
  
  pdf('temp/figures/Fig4.pdf', bg="transparent", height = 12, width = 12)
  par(mar=c(0.1,0.1,0.1,0.1))
  plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=c(0,1), ylim=c(0,1)) 

  grid.picture(e6,x=0.25,y=0.75,width=0.5,height=1)
  grid.picture(e7,x=0.75,y=0.75,width=0.5,height=1)
  grid.picture(e8,x=0.25,y=0.25,width=0.5,height=1)
  grid.picture(e9,x=0.75,y=0.25,width=0.5,height=1)
  
  # text(-0.02,1,'(a)',pos=4,cex=2)
  # text(-0.02,0.45,'(b)',pos=4,cex=2)
  # text(0.515,1,'(c)',pos=4,cex=2)
  # text(0.515,0.46,'(d)',pos=4,cex=2)
  # text(0.785,1,'(e)',pos=4,cex=2)
  # text(0.785,0.46,'(f)',pos=4,cex=2)
  # 
  # text(-0.02,0.61,'5Hz',pos=4,cex=2)
  # text(-0.02,0.89,'7Hz',pos=4,cex=2)

  dev.off()
  
  file.remove(c('timecourse1.ps','timecourse2.ps','timecourse3.ps','timecourse4.ps'))
  file.remove(c('timecourse1.ps.xml','timecourse2.ps.xml','timecourse3.ps.xml','timecourse4.ps.xml'))

  
}

```

```{r MEGdata, fig.cap="E.", fig.align="center", echo=FALSE}

knitr::include_graphics('temp/figures/Fig4.pdf')

```

Figure summarising the MEG experiment
Brains showing location of activity and V1 ROI
Spectra, timecourses
NR for each frequency, mon & dich, split by group


```{r include=FALSE, results='hide'}

if (processdata>0){
load('temp/EEGsummary.RData')

isincluded <- matrix(rep(1,4*dim(allspec)[1]),nrow=4,ncol=dim(allspec)[1])
for (cond in 1:4){
  # note that in allspec the DC component has been removed
  # so we don't need to add 1 to the index
      tempxy <- data.frame(Re(allspec[,cond,duration*targetF]),Im(allspec[,cond,duration*targetF]))
      D5 <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))
      tempxy <- data.frame(Re(allspec[,cond,duration*maskF]),Im(allspec[,cond,duration*maskF]))      
      D7 <- sqrt(mahalanobis(tempxy,colMeans(tempxy),cov(tempxy)))      
      isincluded[cond,which(D5>3)] <- 0
      isincluded[cond,which(D7>3)] <- 0
   for (s in 1:100){
     if (max(abs(EEGtimecourse5Hz[s,cond,]))>5){isincluded[cond,s] <- 0}
   }   
}

allwaves[which(allwaves<(-100))] <- 0
allwaves[which(allwaves>100)] <- 0

medAQ <- median(allAQ)
islowAQ <- rep(0,100)
ishighAQ <- rep(0,100)
islowAQ[which(allAQ<medAQ)] <- 1
ishighAQ[which(allAQ>medAQ)] <- 1

EEGmeantime5HzL <- matrix(0,nrow=4,ncol=8000)
EEGmeantime7HzL <- matrix(0,nrow=4,ncol=8000)
EEGSEtime5HzL <- matrix(0,nrow=4,ncol=8000)
EEGSEtime7HzL <- matrix(0,nrow=4,ncol=8000)
EEGmeantime5HzH <- matrix(0,nrow=4,ncol=8000)
EEGmeantime7HzH <- matrix(0,nrow=4,ncol=8000)
EEGSEtime5HzH <- matrix(0,nrow=4,ncol=8000)
EEGSEtime7HzH <- matrix(0,nrow=4,ncol=8000)

for (cond in 1:4){
lowAQincluded <- islowAQ * isincluded[cond,]
highAQincluded <- ishighAQ * isincluded[cond,]

EEGmeantime7HzL[cond,] <- apply(abs(EEGtimecourse7Hz[which(lowAQincluded==1),cond,]),2,mean,na.rm=TRUE)
EEGmeantime5HzL[cond,] <- apply(abs(EEGtimecourse5Hz[which(lowAQincluded==1),cond,]),2,mean,na.rm=TRUE)

EEGSEtime7HzL[cond,] <- apply(abs(EEGtimecourse7Hz[which(lowAQincluded==1),cond,]),2,sd,na.rm=TRUE)/sqrt(sum(lowAQincluded))
EEGSEtime5HzL[cond,] <- apply(abs(EEGtimecourse5Hz[which(lowAQincluded==1),cond,]),2,sd,na.rm=TRUE)/sqrt(sum(lowAQincluded))

EEGmeantime7HzH[cond,] <- apply(abs(EEGtimecourse7Hz[which(highAQincluded==1),cond,]),2,mean,na.rm=TRUE)
EEGmeantime5HzH[cond,] <- apply(abs(EEGtimecourse5Hz[which(highAQincluded==1),cond,]),2,mean,na.rm=TRUE)

EEGSEtime7HzH[cond,] <- apply(abs(EEGtimecourse7Hz[which(highAQincluded==1),cond,]),2,sd,na.rm=TRUE)/sqrt(sum(highAQincluded))
EEGSEtime5HzH[cond,] <- apply(abs(EEGtimecourse5Hz[which(highAQincluded==1),cond,]),2,sd,na.rm=TRUE)/sqrt(sum(highAQincluded))
}

EEGmaskindex5L <- matrix(0,nrow=2,ncol=8000)
EEGmaskindexSE5L <- matrix(0,nrow=2,ncol=8000)
includedboth <- isincluded[1,]*isincluded[3,]*islowAQ
monratios <- abs(EEGtimecourse5Hz[which(includedboth==1),1,])/abs(EEGtimecourse5Hz[which(includedboth==1),3,])
EEGmaskindex5L[1,] <- colMeans(20*log10(monratios))
EEGmaskindexSE5L[1,] <- apply(20*log10(monratios),2,sd)/sqrt(sum(includedboth))
includedboth <- isincluded[1,]*isincluded[4,]*islowAQ
dichratios <- abs(EEGtimecourse5Hz[which(includedboth==1),1,])/abs(EEGtimecourse5Hz[which(includedboth==1),4,])
EEGmaskindex5L[2,] <- colMeans(20*log10(dichratios))
EEGmaskindexSE5L[2,] <- apply(20*log10(dichratios),2,sd)/sqrt(sum(includedboth))


EEGmaskindex5H <- matrix(0,nrow=2,ncol=8000)
EEGmaskindexSE5H <- matrix(0,nrow=2,ncol=8000)
includedboth <- isincluded[1,]*isincluded[3,]*ishighAQ
monratios <- abs(EEGtimecourse5Hz[which(includedboth==1),1,])/abs(EEGtimecourse5Hz[which(includedboth==1),3,])
EEGmaskindex5H[1,] <- colMeans(20*log10(monratios))
EEGmaskindexSE5H[1,] <- apply(20*log10(monratios),2,sd)/sqrt(sum(includedboth))
includedboth <- isincluded[1,]*isincluded[4,]*ishighAQ
dichratios <- abs(EEGtimecourse5Hz[which(includedboth==1),1,])/abs(EEGtimecourse5Hz[which(includedboth==1),4,])
EEGmaskindex5H[2,] <- colMeans(20*log10(dichratios))
EEGmaskindexSE5H[2,] <- apply(20*log10(dichratios),2,sd)/sqrt(sum(includedboth))


EEGmaskindex7L <- matrix(0,nrow=2,ncol=8000)
EEGmaskindexSE7L <- matrix(0,nrow=2,ncol=8000)
includedboth <- isincluded[2,]*isincluded[3,]*islowAQ
monratios <- abs(EEGtimecourse7Hz[which(includedboth==1),2,])/abs(EEGtimecourse7Hz[which(includedboth==1),3,])
EEGmaskindex7L[1,] <- colMeans(20*log10(monratios))
EEGmaskindexSE7L[1,] <- apply(20*log10(monratios),2,sd)/sqrt(sum(includedboth))
includedboth <- isincluded[2,]*isincluded[4,]*islowAQ
dichratios <- abs(EEGtimecourse7Hz[which(includedboth==1),2,])/abs(EEGtimecourse7Hz[which(includedboth==1),4,])
EEGmaskindex7L[2,] <- colMeans(20*log10(dichratios))
EEGmaskindexSE7L[2,] <- apply(20*log10(dichratios),2,sd)/sqrt(sum(includedboth))


EEGmaskindex7H <- matrix(0,nrow=2,ncol=8000)
EEGmaskindexSE7H <- matrix(0,nrow=2,ncol=8000)
includedboth <- isincluded[2,]*isincluded[3,]*ishighAQ
monratios <- abs(EEGtimecourse7Hz[which(includedboth==1),2,])/abs(EEGtimecourse7Hz[which(includedboth==1),3,])
EEGmaskindex7H[1,] <- colMeans(20*log10(monratios))
EEGmaskindexSE7H[1,] <- apply(20*log10(monratios),2,sd)/sqrt(sum(includedboth))
includedboth <- isincluded[2,]*isincluded[4,]*ishighAQ
dichratios <- abs(EEGtimecourse7Hz[which(includedboth==1),2,])/abs(EEGtimecourse7Hz[which(includedboth==1),4,])
EEGmaskindex7H[2,] <- colMeans(20*log10(dichratios))
EEGmaskindexSE7H[2,] <- apply(20*log10(dichratios),2,sd)/sqrt(sum(includedboth))




times <- ((1:8000)-1000)/1000

for (masktype in 1:2){
postscript(paste0("timecourse",masktype,".ps"), horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,-3,6)
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,7),c(0,0),lty=2)

if (plotsmoothed==0){
polygon(times[c(1:8000,8000:1)],c(EEGmaskindex5L[masktype,]+EEGmaskindexSE5L[masktype,],EEGmaskindex5L[masktype,8000:1]-EEGmaskindexSE5L[masktype,8000:1]),col=colpal[2],border=NA)
polygon(times[c(1:8000,8000:1)],c(EEGmaskindex5H[masktype,]+EEGmaskindexSE5H[masktype,],EEGmaskindex5H[masktype,8000:1]-EEGmaskindexSE5H[masktype,8000:1]),col=colpal[3],border=NA)

lines(times,EEGmaskindex5L[masktype,],col=colpal[2],lwd=2)
lines(times,EEGmaskindex5H[masktype,],col=colpal[3],lwd=2)
}

if (plotsmoothed==1){
U <- smooth.spline(times,EEGmaskindex5L[masktype,]+EEGmaskindexSE5L[masktype,],df=20)
L <- smooth.spline(times,EEGmaskindex5L[masktype,]-EEGmaskindexSE5L[masktype,],df=20)
polygon(times[c(1:8000,8000:1)],c(U$y,L$y[8000:1]),col=colpal[2],border=NA)

U <- smooth.spline(times,EEGmaskindex5H[masktype,]+EEGmaskindexSE5H[masktype,],df=20)
L <- smooth.spline(times,EEGmaskindex5H[masktype,]-EEGmaskindexSE5H[masktype,],df=20)
polygon(times[c(1:8000,8000:1)],c(U$y,L$y[8000:1]),col=colpal[3],border=NA)

L <- smooth.spline(times,EEGmaskindex5L[masktype,],df=20)
lines(L$x,L$y,col=colpal[2],lwd=2)
L <- smooth.spline(times,EEGmaskindex5H[masktype,],df=20)
lines(L$x,L$y,col=colpal[3],lwd=2)
}

dev.off()


postscript(paste0("timecourse",masktype+2,".ps"), horizontal = FALSE, onefile = FALSE, paper = "special", height = 5, width = 5)

plotlims <- c(-1,7,-3,6)
ticklocsy <- seq(-3,6,3)    # locations of tick marks on y axis
plot(x=NULL,y=NULL,axes=FALSE, ann=FALSE, xlim=plotlims[1:2], ylim=plotlims[3:4])
axis(1, at=ticklocsx, tck=0.01, lab=F, lwd=2)
axis(2, at=ticklocsy, tck=0.01, lab=F, lwd=2)
mtext(text = ticklocsx, side = 1, at=ticklocsx)
mtext(text = c(expression(sqrt(2)/2),'1',expression(sqrt(2)),'2'), side = 2, at=ticklocsy, line=0.2, las=1)
title(xlab="Time (s)", col.lab=rgb(0,0,0), line=1.2, cex.lab=1.5)    
title(ylab="Suppression ratio", col.lab=rgb(0,0,0), line=1.5, cex.lab=1.5)

polygon(c(0,6,6,0),c(-3.4,-3.4,-2.6,-2.6),border=NA,col=rgb(0.5,0.5,0.5))

lines(c(-1,7),c(0,0),lty=2)

if (plotsmoothed==0){
polygon(times[c(1:8000,8000:1)],c(EEGmaskindex7L[masktype,]+EEGmaskindexSE7L[masktype,],EEGmaskindex7L[masktype,8000:1]-EEGmaskindexSE7L[masktype,8000:1]),col=colpal[2],border=NA)
polygon(times[c(1:8000,8000:1)],c(EEGmaskindex7H[masktype,]+EEGmaskindexSE7H[masktype,],EEGmaskindex7H[masktype,8000:1]-EEGmaskindexSE7H[masktype,8000:1]),col=colpal[3],border=NA)

lines(times,EEGmaskindex7L[masktype,],col=colpal[2],lwd=2)
lines(times,EEGmaskindex7H[masktype,],col=colpal[3],lwd=2)
}

if (plotsmoothed==1){
U <- smooth.spline(times,EEGmaskindex7L[masktype,]+EEGmaskindexSE7L[masktype,],df=20)
L <- smooth.spline(times,EEGmaskindex7L[masktype,]-EEGmaskindexSE7L[masktype,],df=20)
polygon(times[c(1:8000,8000:1)],c(U$y,L$y[8000:1]),col=colpal[2],border=NA)

U <- smooth.spline(times,EEGmaskindex7H[masktype,]+EEGmaskindexSE7H[masktype,],df=20)
L <- smooth.spline(times,EEGmaskindex7H[masktype,]-EEGmaskindexSE7H[masktype,],df=20)
polygon(times[c(1:8000,8000:1)],c(U$y,L$y[8000:1]),col=colpal[3],border=NA)

L <- smooth.spline(times,EEGmaskindex7L[masktype,],df=20)
lines(L$x,L$y,col=colpal[2],lwd=2)
L <- smooth.spline(times,EEGmaskindex7H[masktype,],df=20)
lines(L$x,L$y,col=colpal[3],lwd=2)
}


dev.off()

}
}

```

Participants showed a wide range of scores on both the AQ and SPQ scales, which were negatively correlated (Fig 3a; R = , p < ). We again performed a median split by AQ on the EEG data, and calculated the timecourse of the EEG response and suppression ratios for each group (Figure 3b,c).

Finally, we split the data set by median AQ score (see Figure 1g). Averaging across frequency, the low AQ group showed a strong increase over the first 4 seconds of the trial, whereas the high AQ group showed a much shallower change over the same time period (Figure 1h).

## Discussion

Priors, Dickinson 2014 oblique effect


## Methods



